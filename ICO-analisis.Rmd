---
title: 'Análisis de Mercado: Barra de Ensaladas'
author: "Noel Lirón Martínez, Raquel Mus Maquieira, Carles Sahuquillo Soriano"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true
  pdf_document:
    toc: true
subtitle: 'Asignatura: Investigación Comercial'
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
# Configuración global
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 10)
```

# Preparación del Entorno

```{r librerias}
# Carga de librerías y configuraciones
if (!require("pacman")) install.packages("pacman")

pacman::p_load(
  readxl, splitstackshape, descr, rstatix, 
  tibble, dplyr, tidyr, ggplot2, 
  xtable, likert, ggpubr, flextable, 
  nortest, DT, RColorBrewer, graphics
)

options(digits = 3)

theme_set(theme_minimal() + 
            theme(plot.title = element_text(face = "bold", hjust = 0.5),
                  legend.position = "bottom"))
```

------------------------------------------------------------------------

# Ingesta y Limpieza de Datos {.tabset}

En esta sección procesamos el archivo crudo `respuestasEncuesta.xlsx`, renombrando las columnas para facilitar su manipulación y convirtiendo las variables categóricas.

## Carga y Renombrado

```{r carga_datos}
# Carga de datos y renombramiento de columnas

datos <- read_excel('respuestasEncuesta.xlsx')

nuevos_nombres <- c(
  'Marca.Temporal',              # Marca temporal
  'Motivo',                      # ¿Cuál es el principal motivo por el que suele comer fuera de casa?
  'Frecuencia',                  # ¿Con qué frecuencia suele comer fuera de casa?
  'Lugar.Habitual',              # Cuando come fuera ¿dónde suele comer?
  'Tipo.Comida',                 # Cuando come fuera, ¿qué tipo de comida suele elegir?
  'Frecuencia.Comida.Preparada', # ¿Con qué frecuencia compra comida preparada en un supermercado?
  'Supermercado.Habitual',       # ¿En qué supermercados suele comprar comida?
  'Importancia.Saludable',       # ¿Qué importancia tiene para usted comer de forma saludable cuando está fuera de casa?
  'Experiencia.Barra.Ensaladas', # ¿Ha probado alguna vez una barra de ensaladas?
  'Mala.Experiencia.Descripcion',# ¿Puede describir alguna mala experiencia que haya tenido con comida preparada o autoservicio...?
  'Situaciones.Uso',             # ¿En qué situaciones utilizaría la barra de ensaladas?
  'Formato.Preferido',           # ¿Qué formato preferiría?
  'Imp.Sostenibilidad',          # Valore importancia: [Sostenibilidad de los envases]
  'Imp.Origen.Local',            # Valore importancia: [Origen local de los productos]
  'Imp.Variedad',                # Valore importancia: [Variedad de ingredientes]
  'Imp.Sabor',                   # Valore importancia: [Sabor]
  'Imp.Precio',                  # Valore importancia: [Precio]
  'Imp.Higiene',                 # Valore importancia: [Higiene]
  'Imp.Rapidez',                 # Valore importancia: [Rapidez del servicio]
  'Preferencia.Base',            # ¿Qué tipo de base prefiere para sus ensaladas? (Hasta 2 opciones)
  'Preferencia.Proteina',        # De las siguientes proteínas ¿cuáles prefiere? (Hasta 2 opciones)
  'Preferencia.Complementos',    # De los siguientes complementos ¿cuáles prefiere? (Hasta 2 opciones)
  'Disposicion.Pago',            # ¿Cuánto está dispuesto/a a pagar por una ensalada completa de tamaño mediano (500g)?
  'Aptitud.Social',              # ¿Qué tan apropiadas considera las ensaladas para comidas en contextos sociales?
  'Preferencia.Dispensacion',    # ¿Qué formato de dispensación preferiría? (Comodidad, rapidez e higiene)
  'Intencion.Uso',               # Si su supermercado habitual ofreciera nuestra barra de ensaladas, ¿la usaría?
  'Edad',                        # ¿En qué rango de edades se encuentra?
  'Genero',                      # ¿Con qué género se identifica?
  'Nivel.Educativo',             # Indique su nivel educativo máximo alcanzado
  'Situacion.Laboral'            # ¿En qué situación laboral se encuentra?
)

colnames(datos) <- nuevos_nombres
```

## Transformación de Variables

Definimos las variables como categóricas.

```{r transformacion}


datos$f_Motivo <- factor(datos$Motivo,
  levels = c('Conveniencia (falta de tiempo, por trabajo, estudios, etc.)', 
             'Reuniones sociales (familia, amigos, compañeros de trabajo, etc.)', 
             'Placer o disfrute personal (por gusto, por probar cosas nuevas, por cambiar de ambiente)', 
             'Circunstancias extraordinarias (viajes, eventos...)', 
             'Nunca como fuera de casa'),
  labels = c('Conveniencia', 'Social', 'Placer', 'Extraordinario', 'Nunca'))

datos$f_Lugar.Habitual <- factor(datos$Lugar.Habitual,
  levels = c('En un bar o restaurante', 
             'En una oficina o centro educativo (cantina, comedor, aula...)', 
             'En la vía pública (parques, calle, transporte, etc.)'),
  labels = c('Restaurante/Bar', 'Oficina/Centro', 'Vía Pública'))

datos$f_Formato.Preferido <- factor(datos$Formato.Preferido,
  levels = c('Tamaños de recipiente fijos con un precio establecido por tamaño', 'Pago por peso'),
  labels = c('Precio Fijo', 'Pago Peso'))

datos$f_Preferencia.Dispensacion <- factor(datos$Preferencia.Dispensacion,
  levels = c('Ingredientes expuestos tras una mampara de cristal, donde el cliente abre la protección y utiliza pinzas para servirse en su propio recipiente (similar a un autoservicio tipo buffet)', 
             'Ingredientes protegidos por una barrera de cristal fija, sin acceso directo. Se utilizan palas largas para dispensarlos desde un lateral, evitando cualquier contacto del cliente con el producto, aunque con algo menos de comodidad (similar al sistema de algunas panaderías)', 
             'Ingredientes servidos por personal de atención.'),
  labels = c('Autoservicio', 'Protección Fija', 'Personal'))

datos$f_Genero <- factor(datos$Genero,
  levels = c('Mujer', 'Hombre', 'Prefiero no decirlo', 'Otro:'),
  labels = c('Mujer', 'Hombre', 'NS/NC', 'Otro'))

datos$f_Situacion.Laboral <- factor(datos$Situacion.Laboral,
  levels = c('Estudiante', 'Trabajador/a por cuenta ajena', 'Autónomo/a', 'Desempleado/a', 'Jubilado/a', 'Prefiero no decirlo'),
  labels = c('Estudiante', 'Cuenta Ajena', 'Autónomo', 'Desempleado', 'Jubilado', 'NS/NC'))

datos$f_Experiencia.Barra <- factor(datos$Experiencia.Barra.Ensaladas, levels = c('Sí', 'No'))
datos$f_Intencion.Uso <- factor(datos$Intencion.Uso, levels = c('Sí', 'No'))

datos$f_Frecuencia <- factor(datos$Frecuencia,
  levels = c('Rara vez / Nunca', 'Ocasionalmente', '1 o 2 veces por semana', '3 o 4 veces por semana', '5 o más veces por semana'),
  labels = c('Nunca/Rara', 'Ocasional', '1-2/sem', '3-4/sem', '5+/sem'))

datos$f_Frecuencia.Comida.Preparada <- factor(datos$Frecuencia.Comida.Preparada,
  levels = c('Rara vez / Nunca', 'Ocasionalmente', '1 o 2 veces por semana', '3 o 4 veces por semana', '5 o más veces por semana'),
  labels = c('Nunca/Rara', 'Ocasional', '1-2/sem', '3-4/sem', '5+/sem'))

# Escalas Likert (1-5)
niveles_likert <- c(1:5)
etiquetas_likert <- c('1', '2', '3', '4', '5')

datos$f_Importancia.Saludable <- factor(datos$Importancia.Saludable, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Sostenibilidad    <- factor(datos$Imp.Sostenibilidad, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Origen.Local      <- factor(datos$Imp.Origen.Local, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Variedad          <- factor(datos$Imp.Variedad, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Sabor             <- factor(datos$Imp.Sabor, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Precio            <- factor(datos$Imp.Precio, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Higiene           <- factor(datos$Imp.Higiene, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Rapidez           <- factor(datos$Imp.Rapidez, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Aptitud.Social        <- factor(datos$Aptitud.Social, levels = niveles_likert, labels = etiquetas_likert)

datos$f_Disposicion.Pago <- factor(datos$Disposicion.Pago,
  levels = c('Menos de 4€', 'Entre 4 y 5,49€', 'Entre 5,50 y 7€', 'Entre 7 y 9,50€', 'Más de 9,50€'),
  labels = c('<4€', '4-5.5€', '5.5-7€', '7-9.5€', '>9.5€'))

datos$f_Edad <- factor(datos$Edad,
  levels = c('Menor de 18', '18 - 24', '25 - 44', '45 - 64', '65+'))

datos$f_Nivel.Educativo <- factor(datos$Nivel.Educativo,
  levels = c('ESO (antiguo BUP)', 'FP medio o Bachillerato (antiguo COU)', 'FP superior', 'Universitario/a'),
  labels = c('ESO', 'Bachiller/FPm', 'FPs', 'Univ'))

# ----- PREGUNTAS CON MÁS DE UNA RESPUESTA ---

# Lista de variables multirespuesta
multi_res <- c("Tipo.Comida", "Supermercado.Habitual", "Situaciones.Uso", 
                "Preferencia.Base", "Preferencia.Proteina", "Preferencia.Complementos")

# Aplicamos cSplit_e a cada una (separa por ", " y rellena con 0)
for (var in multi_res) {
  datos <- cSplit_e(datos, var, sep = ', ', type = 'character', fill = 0)
}


# !!!!!!!!!!!!!!!!!!!!! Si alguno da error es porque nadie lo ha marcado en la encuesta y la columna no existe, sería comentar esa línea

# --- P4: Tipo de Comida ---
datos$f_Tipo.Comida.Rapida <- factor(datos$`Tipo.Comida_Comida rápida`, 
                                     levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Tipo.Comida.Restaurante <- factor(datos$`Tipo.Comida_Comida preparada en un bar o restaurante (Excluyendo comida rápida)`, 
                                          levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Tipo.Comida.Super <- factor(datos$`Tipo.Comida_Platos preparados de supermercado`, 
                                    levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Tipo.Comida.Propia <- factor(datos$`Tipo.Comida_De elaboración propia`, 
                                     levels = c(0, 1), labels = c('No', 'Sí'))

# --- P6: Supermercados (Principales) ---

datos$f_Super.Mercadona <- factor(datos$Supermercado.Habitual_Mercadona, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Consum    <- factor(datos$Supermercado.Habitual_Consum, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Carrefour <- factor(datos$Supermercado.Habitual_Carrefour, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Lidl      <- factor(datos$Supermercado.Habitual_Lidl, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Aldi      <- factor(datos$Supermercado.Habitual_Aldi, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Masymas   <- factor(datos$Supermercado.Habitual_Masymas, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Alcampo   <- factor(datos$Supermercado.Habitual_Alcampo, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Gadis     <- factor(datos$Supermercado.Habitual_Gadis, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Fnac      <- factor(datos$Supermercado.Habitual_Fnac, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.DIA       <- factor(datos$Supermercado.Habitual_DIA, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Dialprix  <- factor(datos$Supermercado.Habitual_Dialprix, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Lefties   <- factor(datos$Supermercado.Habitual_Lefties, levels = c(0, 1), labels = c('No', 'Sí'))

# --- P10: Situaciones de Uso ---
datos$f_Uso.Momento <- factor(datos$`Situaciones.Uso_Para comer en el momento`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Uso.Llevar  <- factor(datos$`Situaciones.Uso_Para llevar al trabajo/universidad`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Uso.Cena    <- factor(datos$`Situaciones.Uso_Como cena ligera`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Uso.Complem <- factor(datos$`Situaciones.Uso_Como complemento de otra comida`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Uso.Nunca   <- factor(datos$`Situaciones.Uso_Nunca`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))

# --- P13: Preferencia Base ---
datos$f_Base.Lechuga <- factor(datos$`Preferencia.Base_Lechuga iceberg o romana`, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
# Cuidado con esta línea, el nombre es muy largo y tiene símbolos:
datos$f_Base.Verde   <- factor(datos$`Preferencia.Base_Mezcla verde: rúcula/canónigos/espinacas...`,
                               levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Base.Pasta   <- factor(datos$Preferencia.Base_Pasta, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Base.Quinoa  <- factor(datos$Preferencia.Base_Quinoa, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Base.Cuscus  <- factor(datos$`Preferencia.Base_Cuscús`, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Base.Legum   <- factor(datos$Preferencia.Base_Legumbres, 
                               levels = c(0, 1), labels = c('No', 'Sí'))

# --- P14: Proteínas ---
datos$f_Prot.Pollo   <- factor(datos$Preferencia.Proteina_Pollo, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Pescado <- factor(datos$Preferencia.Proteina_Pescado, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Huevo   <- factor(datos$Preferencia.Proteina_Huevo, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Queso   <- factor(datos$Preferencia.Proteina_Quesos, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Tofu    <- factor(datos$Preferencia.Proteina_Tofu, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Marisco <- factor(datos$Preferencia.Proteina_Marisco, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Carne   <- factor(datos$Preferencia.Proteina_Carne, levels = c(0, 1), labels = c('No', 'Sí'))

# --- P15: Complementos ---
datos$f_Complem.Frutas   <- factor(datos$`Preferencia.Complementos_Frutas varias`, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Complem.Secos    <- factor(datos$`Preferencia.Complementos_Frutos secos/semillas`, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Complem.Verduras <- factor(datos$`Preferencia.Complementos_Verduras cocinadas`, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Complem.Salsas   <- factor(datos$`Preferencia.Complementos_Salsas varias`, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Complem.Especias    <- factor(datos$Preferencia.Complementos_Especias, levels = c(0, 1), labels = c('No', 'Sí'))

# Verificación final
colnames(datos)
```

## Control de consistencia

Hemos introducido un control de consistencia en la pregunta sobre el supermercado en el que el encuestado compra comida habitualmente.
Dos de las posibles respuestas son `Fnac` y `Lefties`, que no son supermercados.
Por tanto, tendremos que descartar aquellos cuestionarios que tengan marcada alguna de estas respuestas, ya que es muy probable que hayan sido respondidos al azar o de forma poca seria.

```{r control consistencia}

n.filas.bruto <- dim(datos)[1]

datos <- subset(datos, !grepl('Fnac|Lefties', Supermercado.Habitual))

n.filas <- dim(datos)[1]

```

En el trabajo de campo recogimos inicialmente `r n.filas.bruto` cuestionarios.
Tras realizar el control de consistencia, nuestra muestra efectiva es de `r n.filas` cuestionarios válidos.

# Estadísticos descriptivos (Análisis Univariante) {.tabset}

Vamos a distinguir tres tipos de variables: categóricas, numéricas y cualitativas.
Cada una tiene un tratamiento descriptivo diferente.

## Variables catégoricas

### Caso de variables con categorías carentes de orden

#### `f_Motivo`

Las categorías de `f_Motivo` son los motivos por los que los encuestados comen fuera de casa.
Se trata de una variable cuyas categorías no guardan una relación de orden entre sí.

```{r P1-tarta}
# Crear el data frame de frecuencias y porcentajes usando dplyr
datos_grafico <- datos %>%
  # Contar la frecuencia de cada nivel de la variable f_Motivo
  count(f_Motivo, name = "Frecuencia") %>%
  # Calcular el porcentaje y el texto de la etiqueta
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Etiquetas = paste0(f_Motivo, "\n(", round(Porcentaje, 1), "%)") # Etiqueta para el gráfico
  ) %>%
  # Eliminar filas con 0% si existen, y categorías no deseadas
  filter(Porcentaje > 0 & f_Motivo != "Total") # Se filtra 'Total' aunque dplyr no lo añade

# Usamos el vector de Porcentaje para el tamaño de las porciones
pie(datos_grafico$Porcentaje,
    # Usamos las Etiquetas que combinan nombre y porcentaje
    labels = datos_grafico$Etiquetas,
    # Título
    main = 'Figura 1. Motivos de compra.',
    # Asignar un color diferente a cada porción
    col = RColorBrewer::brewer.pal(n = nrow(datos_grafico), name = "Set3"))

```

Se observa que `Conveniencia` es el principal motivo por el que los encuestados comen fuera de casa, representando el 38.1% de la muestra.
A continuación presentamos los resultados en formato de tabla:

```{r P1-tabla}
# Preparación de datos
df_tabla_motivo <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Motivo, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Motivo = "Total",
  Frecuencia = sum(df_tabla_motivo$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_motivo, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 1. Distribución de frecuencias para Motivo de Comer Fuera.") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Motivo = "Motivo de Comer Fuera",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Lugar.Habitual`

Las categorías de `f_Lugar.Habitual` son los lugares en los que los encuestados comen fuera de casa.
Se trata de una variable cuyas categorías no guardan una relación de orden entre sí.

```{r P3-tarta}
# Crear el data frame de frecuencias y porcentajes usando dplyr
datos_grafico <- datos %>%
  # Contar la frecuencia de cada nivel de la variable f_Lugar.Habitual
  count(f_Lugar.Habitual, name = "Frecuencia") %>%
  # Calcular el porcentaje y el texto de la etiqueta
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Etiquetas = paste0(f_Lugar.Habitual, "\n(", round(Porcentaje, 1), "%)") # Etiqueta para el gráfico
  ) %>%
  # Eliminar filas con 0% si existen, y categorías no deseadas
  filter(Porcentaje > 0 & f_Lugar.Habitual != "Total") # Se filtra 'Total' aunque dplyr no lo añade

# Usamos el vector de Porcentaje para el tamaño de las porciones
pie(datos_grafico$Porcentaje,
    # Usamos las Etiquetas que combinan nombre y porcentaje
    labels = datos_grafico$Etiquetas,
    # Título
    main = 'Figura 2. Lugar habitual.',
    # Asignar un color diferente a cada porción
    col = RColorBrewer::brewer.pal(n = nrow(datos_grafico), name = "Set3"))

```

Se observa que `Restaurante/Bar` es el principal lugar en el que los encuestados comen fuera de casa, representando el 66.7% de la muestra.
A continuación presentamos los resultados en formato de tabla:

```{r P3-tabla}
# Preparación de datos
df_tabla_lugar <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Lugar.Habitual, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Lugar.Habitual = "Total",
  Frecuencia = sum(df_tabla_lugar$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_lugar, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 2. Distribución de frecuencias para Lugar habitual en el que se come fuera de casa.") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Lugar.Habitual = "Lugar Habitual",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Tipo.Comida`

Las categorías de `f_Tipo.Comida` hacen referencia al tipo de comida que los encuestados suelen comer cuando comen fuera de casa.
Es importante destacar que esta variable proviene de una pregunta con respuesta múltiple por lo que optamos por un gráfico de barras múltiple basándonos en si ha se ha seleccionado cada respuesta o no.

```{r P4-barras, fig.height=6, fig.width=10}
# Definir las variables a analizar (P4: Tipo de Comida)
multi_vars <- c("f_Tipo.Comida.Rapida", "f_Tipo.Comida.Restaurante", "f_Tipo.Comida.Super", 
                "f_Tipo.Comida.Propia")

# Transformar a formato largo y contar frecuencias de SÍ/NO
df_barras_dobles <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Tipo_de_Comida", 
    values_to = "Respuesta"
  ) %>%
  dplyr::count(Tipo_de_Comida, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Tipo_de_Comida = gsub("f_Tipo.Comida.", "", Tipo_de_Comida, fixed = TRUE),
    Tipo_de_Comida = tools::toTitleCase(Tipo_de_Comida),
    Respuesta = factor(Respuesta, levels = c("No", "Sí")) 
  )

# Generación del Gráfico de Barras Agrupadas (Horizontal)
ggplot(df_barras_dobles, aes(x = Tipo_de_Comida, y = Frecuencia, fill = Respuesta)) +
  
  # Barras agrupadas
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) + 
  
  # Etiquetas de Frecuencia
  geom_text(
    aes(label = Frecuencia),
    position = position_dodge(width = 0.9),
    hjust = -0.2, # Mueve la etiqueta -0.2 unidades a lo largo del eje X (separa de la barra)
    size = 3.5
  ) +
  
  # Títulos y Ejes
  labs(
    title = "Figura 3. Gráfico de barras (Sí/No) por Tipo de Comida",
    x = "Tipo de Comida Consumida",
    y = "Número de Respuestas",
    fill = "Consumo"
  ) +
  
  # Colores
  scale_fill_manual(values = c("No" = "#a6cee3", "Sí" = "#1f78b4")) + 
  
  # Invertir coordenadas para hacerlo horizontal
  coord_flip() + 
  
  # Ajuste del eje para que no se corten las etiquetas (Aumentamos el espacio)
  scale_y_continuous(expand = expansion(mult = c(0, 0.20))) + 
  
  # Ajuste de Tema
  theme(legend.position = "bottom")
```

Se observa una clara dominancia del consumo de comida de restaurante (con 43 respuestas afirmativas), seguido de comida de elaboración propia (con 19 respuestas afirmativas).
Estos resultados sugieren que los consumidores están acostumbrados a un formato de comida que prioriza una comida preparada y de calidad.
A continuación presentamos los resultados en formato de tabla:

```{r P4-tabla}
# Transformar a formato largo, contar frecuencias de SÍ/NO y calcular porcentajes
df_tabla_temp <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Tipo_de_Comida_Raw", 
    values_to = "Respuesta" 
  ) %>%
  dplyr::count(Tipo_de_Comida_Raw, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Porcentaje = (Frecuencia / n.filas) * 100
  ) %>%
  tidyr::pivot_wider(
    names_from = Respuesta, 
    values_from = c(Frecuencia, Porcentaje),
    values_fill = 0 
  ) %>%
  dplyr::mutate(
    Tipo_de_Comida = gsub("f_Tipo.Comida.", "", Tipo_de_Comida_Raw, fixed = TRUE),
    Tipo_de_Comida = tools::toTitleCase(Tipo_de_Comida)
  ) %>%
  dplyr::select(
    Tipo_de_Comida,
    `Frecuencia_Sí`, `Porcentaje_Sí`,
    `Frecuencia_No`, `Porcentaje_No`
  )


# Fila de Total
df_total <- data.frame(
  Tipo_de_Comida = "Total",
  Frecuencia_Sí = sum(df_tabla_temp$Frecuencia_Sí),
  Porcentaje_Sí = NA, # No se suma, sería engañoso
  Frecuencia_No = sum(df_tabla_temp$Frecuencia_No),
  Porcentaje_No = NA # No se suma, sería engañoso
)

# Unir el data frame con la fila total
df_tabla_final <- bind_rows(df_tabla_temp, df_total)


# Generación de la tabla (flextable)
ft_si_no <- flextable::flextable(df_tabla_final) %>%
  
  # Añadir Título
  flextable::set_caption(caption = "Tabla 3. Distribución de Frecuencias (Sí/No) para Tipos de Comida") %>%
  
  # Renombrar cabeceras (se usan para la segunda fila de la cabecera)
  flextable::set_header_labels(
    Tipo_de_Comida = "Tipo de Comida",
    Frecuencia_Sí = "Frecuencia (n)",
    Porcentaje_Sí = "Porcentaje",
    Frecuencia_No = "Frecuencia (n)",
    Porcentaje_No = "Porcentaje"
  ) %>%
  
  # Agrupar las columnas 'Sí' y 'No' en una fila superior
  flextable::add_header_row(
    values = c(" ", "SÍ", "NO"),
    colwidths = c(1, 2, 2)
  ) %>%
  
  # Formato y Tema
  flextable::colformat_double(j = c(3, 5), digits = 1, suffix = "%", na_str = "") %>% 
  
  flextable::theme_booktabs() %>% 
  
  # Alineación
  # Aplicar negrita y bordes a la fila "Total" (la última fila)
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% 
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Alineación
  flextable::align(align = "center", part = "all") %>%
  flextable::align(j = 1, align = "left", part = "body") %>%
  
  # Ajustar
  flextable::autofit()

# Mostrar la tabla
ft_si_no
```

#### `f_Supermercado.Habitual`

Las categorías de `f_Supermercado.Habitual` hacen referencia al supermercado en el que los encuestados suelen comprar comida.
Es importante destacar que esta variable proviene de una pregunta con respuesta múltiple por lo que optamos por un gráfico de barras múltiple basándonos en si ha se ha seleccionado cada respuesta o no.
También destacamos que esta pregunta es de control y no tiene más trascendencia.

```{r P6-barras, fig.height=8, fig.width=14}
# Definir las variables a analizar (P6: Supermercado)
multi_vars <- c("f_Super.Carrefour", "f_Super.Lidl", "f_Super.Mercadona", "f_Super.Consum", "f_Super.Aldi", "f_Super.Masymas", "f_Super.Alcampo", "f_Super.DIA", "f_Super.Dialprix")
#FALTA GADIS PORQUE NO SE HA ELEGIDO

# Transformar a formato largo y contar frecuencias de SÍ/NO
df_barras_dobles <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Supermercado_Habitual", 
    values_to = "Respuesta"
  ) %>%
  dplyr::count(Supermercado_Habitual, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Supermercado_Habitual = gsub("f_Super.", "", Supermercado_Habitual, fixed = TRUE),
    Supermercado_Habitual = tools::toTitleCase(Supermercado_Habitual),
    Respuesta = factor(Respuesta, levels = c("No", "Sí")) 
  )

# Generación del Gráfico de Barras Agrupadas (Horizontal)
ggplot(df_barras_dobles, aes(x = Supermercado_Habitual, y = Frecuencia, fill = Respuesta)) +
  
  # Barras agrupadas
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) + 
  
  # Etiquetas de Frecuencia
  geom_text(
    aes(label = Frecuencia),
    position = position_dodge(width = 0.9),
    hjust = -0.2, # Mueve la etiqueta -0.2 unidades a lo largo del eje X (separa de la barra)
    size = 3.5
  ) +
  
  # Títulos y Ejes
  labs(
    title = "Figura 4. Gráfico de barras (Sí/No) por Supermercado",
    x = "Supermercado Habitual",
    y = "Número de Respuestas",
    fill = "Elegido"
  ) +
  
  # Colores
  scale_fill_manual(values = c("No" = "#a6cee3", "Sí" = "#1f78b4")) + 
  
  # Invertir coordenadas para hacerlo horizontal
  coord_flip() + 
  
  # Ajuste del eje para que no se corten las etiquetas (Aumentamos el espacio)
  scale_y_continuous(expand = expansion(mult = c(0, 0.20))) + 
  
  # Ajuste de Tema
  theme(legend.position = "bottom")
```

Se observa una clara dominancia de Mercadona (con 51 respuestas afirmativas), seguido de Consum (con 30 respuestas afirmativas).
A continuación presentamos los resultados en formato de tabla:

```{r P6-tabla}
# Transformar a formato largo, contar frecuencias de SÍ/NO y calcular porcentajes
df_tabla_temp <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Supermercado_Habitual_Raw", 
    values_to = "Respuesta" 
  ) %>%
  dplyr::count(Supermercado_Habitual_Raw, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Porcentaje = (Frecuencia / n.filas) * 100
  ) %>%
  tidyr::pivot_wider(
    names_from = Respuesta, 
    values_from = c(Frecuencia, Porcentaje),
    values_fill = 0 
  ) %>%
  dplyr::mutate(
    Supermercado_Habitual = gsub("f_Super.", "", Supermercado_Habitual_Raw, fixed = TRUE),
    Supermercado_Habitual = tools::toTitleCase(Supermercado_Habitual)
  ) %>%
  dplyr::select(
    Supermercado_Habitual,
    `Frecuencia_Sí`, `Porcentaje_Sí`,
    `Frecuencia_No`, `Porcentaje_No`
  )


# Fila de Total
df_total <- data.frame(
  Supermercado_Habitual = "Total",
  Frecuencia_Sí = sum(df_tabla_temp$Frecuencia_Sí),
  Porcentaje_Sí = NA, # No se suma, sería engañoso
  Frecuencia_No = sum(df_tabla_temp$Frecuencia_No),
  Porcentaje_No = NA # No se suma, sería engañoso
)

# Unir el data frame con la fila total
df_tabla_final <- bind_rows(df_tabla_temp, df_total)


# Generación de la tabla (flextable)
ft_si_no <- flextable::flextable(df_tabla_final) %>%
  
  # Añadir Título
  flextable::set_caption(caption = "Tabla 4. Distribución de Frecuencias (Sí/No) para Supermercados") %>%
  
  # Renombrar cabeceras (se usan para la segunda fila de la cabecera)
  flextable::set_header_labels(
    Supermercado_Habitual = "Supermercado Habitual",
    Frecuencia_Sí = "Frecuencia (n)",
    Porcentaje_Sí = "Porcentaje",
    Frecuencia_No = "Frecuencia (n)",
    Porcentaje_No = "Porcentaje"
  ) %>%
  
  # Agrupar las columnas 'Sí' y 'No' en una fila superior
  flextable::add_header_row(
    values = c(" ", "SÍ", "NO"),
    colwidths = c(1, 2, 2)
  ) %>%
  
  # Formato y Tema
  flextable::colformat_double(j = c(3, 5), digits = 1, suffix = "%", na_str = "") %>% 
  
  flextable::theme_booktabs() %>% 
  
  # Alineación
  # Aplicar negrita y bordes a la fila "Total" (la última fila)
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% 
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Alineación
  flextable::align(align = "center", part = "all") %>%
  flextable::align(j = 1, align = "left", part = "body") %>%
  
  # Ajustar
  flextable::autofit()

# Mostrar la tabla
ft_si_no
```

#### `f_Experiencia.Barra`

Las categorías de `f_Experiencia.Barra` hacen referencia a si el encuestado a probado una barra de ensaladas previamente.
Se trata de una variable cuyas categorías no guardan una relación de orden entre sí.

```{r P8-tarta}
# Crear el data frame de frecuencias y porcentajes usando dplyr
datos_grafico <- datos %>%
  # Contar la frecuencia de cada nivel de la variable f_Experiencia.Barra
  count(f_Experiencia.Barra, name = "Frecuencia") %>%
  # Calcular el porcentaje y el texto de la etiqueta
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Etiquetas = paste0(f_Experiencia.Barra, "\n(", round(Porcentaje, 1), "%)") # Etiqueta para el gráfico
  ) %>%
  # Eliminar filas con 0% si existen, y categorías no deseadas
  filter(Porcentaje > 0 & f_Experiencia.Barra != "Total") # Se filtra 'Total' aunque dplyr no lo añade

# Usamos el vector de Porcentaje para el tamaño de las porciones
pie(datos_grafico$Porcentaje,
    # Usamos las Etiquetas que combinan nombre y porcentaje
    labels = datos_grafico$Etiquetas,
    # Título
    main = 'Figura 5. Experiencia con barra de ensaldas.',
    # Asignar un color diferente a cada porción
    col = RColorBrewer::brewer.pal(n = nrow(datos_grafico), name = "Set3"))

```

Se observa que la mayoría de los encuestados no habían probado una barra de ensaladas (73%), frente a los que si (27%).
A continuación presentamos los resultados en formato de tabla:

```{r P8-tabla}
# Preparación de datos
df_tabla_experiencia <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Experiencia.Barra, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Experiencia.Barra = "Total",
  Frecuencia = sum(df_tabla_experiencia$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_experiencia, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 5. Distribución de frecuencias para Experiencia previa con una barra de ensaladas") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Experiencia.Barra = "Experiencia con una barra de ensaladas",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Situaciones.Uso`

Las categorías de `f_Situaciones.Uso` hacen referencia a las situaciones en que los encuestados utilizarían la barra de ensaladas.
Es importante destacar que esta variable proviene de una pregunta con respuesta múltiple por lo que optamos por un gráfico de barras múltiple basándonos en si ha se ha seleccionado cada respuesta o no.

```{r P10-barras, fig.height=6, fig.width=10}
# Definir las variables a analizar (P10: Situaciones de Uso)
multi_vars <- c("f_Uso.Momento", "f_Uso.Llevar", "f_Uso.Cena", "f_Uso.Complem", "f_Uso.Nunca")

# Transformar a formato largo y contar frecuencias de SÍ/NO
df_barras_dobles <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Situaciones_Uso", 
    values_to = "Respuesta"
  ) %>%
  dplyr::count(Situaciones_Uso, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Situaciones_Uso = gsub("f_Uso.", "", Situaciones_Uso, fixed = TRUE),
    Situaciones_Uso = tools::toTitleCase(Situaciones_Uso),
    Respuesta = factor(Respuesta, levels = c("No", "Sí")) 
  )

# Generación del Gráfico de Barras Agrupadas (Horizontal)
ggplot(df_barras_dobles, aes(x = Situaciones_Uso, y = Frecuencia, fill = Respuesta)) +
  
  # Barras agrupadas
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) + 
  
  # Etiquetas de Frecuencia
  geom_text(
    aes(label = Frecuencia),
    position = position_dodge(width = 0.9),
    hjust = -0.2, # Mueve la etiqueta -0.2 unidades a lo largo del eje X (separa de la barra)
    size = 3.5
  ) +
  
  # Títulos y Ejes
  labs(
    title = "Figura 6. Gráfico de barras (Sí/No) por Situaciones de Uso",
    x = "Situación de Uso",
    y = "Número de Respuestas",
    fill = "Usaría"
  ) +
  
  # Colores
  scale_fill_manual(values = c("No" = "#a6cee3", "Sí" = "#1f78b4")) + 
  
  # Invertir coordenadas para hacerlo horizontal
  coord_flip() + 
  
  # Ajuste del eje para que no se corten las etiquetas (Aumentamos el espacio)
  scale_y_continuous(expand = expansion(mult = c(0, 0.20))) + 
  
  # Ajuste de Tema
  theme(legend.position = "bottom")
```

Se observa que se optaría por tomar la ensalada para llevar al trabajo/universidad (con 25 respuestas afirmativas) o bien para comer en el momento (con 30 respuestas afirmativas).
A continuación presentamos los resultados en formato de tabla:

```{r P10-tabla}
# Transformar a formato largo, contar frecuencias de SÍ/NO y calcular porcentajes
df_tabla_temp <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Situaciones_Uso_Raw", 
    values_to = "Respuesta" 
  ) %>%
  dplyr::count(Situaciones_Uso_Raw, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Porcentaje = (Frecuencia / n.filas) * 100
  ) %>%
  tidyr::pivot_wider(
    names_from = Respuesta, 
    values_from = c(Frecuencia, Porcentaje),
    values_fill = 0 
  ) %>%
  dplyr::mutate(
    Situaciones_Uso = gsub("f_Uso.", "", Situaciones_Uso_Raw, fixed = TRUE),
    Situaciones_Uso = tools::toTitleCase(Situaciones_Uso)
  ) %>%
  dplyr::select(
    Situaciones_Uso,
    `Frecuencia_Sí`, `Porcentaje_Sí`,
    `Frecuencia_No`, `Porcentaje_No`
  )


# Fila de Total
df_total <- data.frame(
  Situaciones_Uso = "Total",
  Frecuencia_Sí = sum(df_tabla_temp$Frecuencia_Sí),
  Porcentaje_Sí = NA, # No se suma, sería engañoso
  Frecuencia_No = sum(df_tabla_temp$Frecuencia_No),
  Porcentaje_No = NA # No se suma, sería engañoso
)

# Unir el data frame con la fila total
df_tabla_final <- bind_rows(df_tabla_temp, df_total)


# Generación de la tabla (flextable)
ft_si_no <- flextable::flextable(df_tabla_final) %>%
  
  # Añadir Título
  flextable::set_caption(caption = "Tabla 6. Distribución de Frecuencias (Sí/No) para Situaciones de Uso") %>%
  
  # Renombrar cabeceras (se usan para la segunda fila de la cabecera)
  flextable::set_header_labels(
    Situaciones_Uso = "Situación de Uso",
    Frecuencia_Sí = "Frecuencia (n)",
    Porcentaje_Sí = "Porcentaje",
    Frecuencia_No = "Frecuencia (n)",
    Porcentaje_No = "Porcentaje"
  ) %>%
  
  # Agrupar las columnas 'Sí' y 'No' en una fila superior
  flextable::add_header_row(
    values = c(" ", "SÍ", "NO"),
    colwidths = c(1, 2, 2)
  ) %>%
  
  # Formato y Tema
  flextable::colformat_double(j = c(3, 5), digits = 1, suffix = "%", na_str = "") %>% 
  
  flextable::theme_booktabs() %>% 
  
  # Alineación
  # Aplicar negrita y bordes a la fila "Total" (la última fila)
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% 
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Alineación
  flextable::align(align = "center", part = "all") %>%
  flextable::align(j = 1, align = "left", part = "body") %>%
  
  # Ajustar
  flextable::autofit()

# Mostrar la tabla
ft_si_no
```

#### `f_Formato.Preferido`

Las categorías de `f_Formato.Preferido` se diferencian en si el encuestado prefiere que las ensaladas se paguen por peso o tengan un precio fijado.
Se trata de una variable cuyas categorías no guardan una relación de orden entre sí.

```{r P11-tarta}
# Crear el data frame de frecuencias y porcentajes usando dplyr
datos_grafico <- datos %>%
  # Contar la frecuencia de cada nivel de la variable f_Formato.Preferido
  count(f_Formato.Preferido, name = "Frecuencia") %>%
  # Calcular el porcentaje y el texto de la etiqueta
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Etiquetas = paste0(f_Formato.Preferido, "\n(", round(Porcentaje, 1), "%)") # Etiqueta para el gráfico
  ) %>%
  # Eliminar filas con 0% si existen, y categorías no deseadas
  filter(Porcentaje > 0 & f_Formato.Preferido != "Total") # Se filtra 'Total' aunque dplyr no lo añade

# Usamos el vector de Porcentaje para el tamaño de las porciones
pie(datos_grafico$Porcentaje,
    # Usamos las Etiquetas que combinan nombre y porcentaje
    labels = datos_grafico$Etiquetas,
    # Título
    main = 'Figura 7. Formato preferido',
    # Asignar un color diferente a cada porción
    col = RColorBrewer::brewer.pal(n = nrow(datos_grafico), name = "Set3"))

```

Se observa que la mayoría optaría por un formato donde el precio de las ensaldas es fijo (81%), frente a los que prefieren que se pagara la ensalada por peso (19%).

```{r P11-tabla}
# Preparación de datos
df_tabla_formato <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Formato.Preferido, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Formato.Preferido = "Total",
  Frecuencia = sum(df_tabla_formato$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_formato, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 7. Distribución de frecuencias para Formato preferido") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Formato.Preferido = "Formato Preferido",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Preferencia.Base`

Las categorías de `f_Preferencia.Base` hacen referencia a las bases para la ensalada que los encuestados aplicarían a sus ensaladas.
Es importante destacar que esta variable proviene de una pregunta con respuesta múltiple por lo que optamos por un gráfico de barras múltiple basándonos en si ha se ha seleccionado cada respuesta o no.

```{r P13-barras, fig.height=6, fig.width=10}
# Definir las variables a analizar (P10: Situaciones de Uso)
multi_vars <- c("f_Base.Lechuga", "f_Base.Verde", "f_Base.Pasta", "f_Base.Quinoa", "f_Base.Cuscus", "f_Base.Legum")

# Transformar a formato largo y contar frecuencias de SÍ/NO
df_barras_dobles <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Preferencia_Base", 
    values_to = "Respuesta"
  ) %>%
  dplyr::count(Preferencia_Base, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Preferencia_Base = gsub("f_Base.", "", Preferencia_Base, fixed = TRUE),
    Preferencia_Base = tools::toTitleCase(Preferencia_Base),
    Respuesta = factor(Respuesta, levels = c("No", "Sí")) 
  )

# Generación del Gráfico de Barras Agrupadas (Horizontal)
ggplot(df_barras_dobles, aes(x = Preferencia_Base, y = Frecuencia, fill = Respuesta)) +
  
  # Barras agrupadas
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) + 
  
  # Etiquetas de Frecuencia
  geom_text(
    aes(label = Frecuencia),
    position = position_dodge(width = 0.9),
    hjust = -0.2, # Mueve la etiqueta -0.2 unidades a lo largo del eje X (separa de la barra)
    size = 3.5
  ) +
  
  # Títulos y Ejes
  labs(
    title = "Figura 8. Gráfico de barras (Sí/No) por Preferencia de Base",
    x = "Preferencia Base",
    y = "Número de Respuestas",
    fill = "Usaría"
  ) +
  
  # Colores
  scale_fill_manual(values = c("No" = "#a6cee3", "Sí" = "#1f78b4")) + 
  
  # Invertir coordenadas para hacerlo horizontal
  coord_flip() + 
  
  # Ajuste del eje para que no se corten las etiquetas (Aumentamos el espacio)
  scale_y_continuous(expand = expansion(mult = c(0, 0.20))) + 
  
  # Ajuste de Tema
  theme(legend.position = "bottom")
```

Se observa que la base más que se usaría seria la mezcla verde de rúcula, canónigos, espinacas...
(con 38 respuestas afirmativas), seguido de pasta (con 29 respuestas afirmativas).

```{r P13-tabla}
# Transformar a formato largo, contar frecuencias de SÍ/NO y calcular porcentajes
df_tabla_temp <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Preferencia_Base_Raw", 
    values_to = "Respuesta" 
  ) %>%
  dplyr::count(Preferencia_Base_Raw, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Porcentaje = (Frecuencia / n.filas) * 100
  ) %>%
  tidyr::pivot_wider(
    names_from = Respuesta, 
    values_from = c(Frecuencia, Porcentaje),
    values_fill = 0 
  ) %>%
  dplyr::mutate(
    Preferencia_Base = gsub("f_Base.", "", Preferencia_Base_Raw, fixed = TRUE),
    Preferencia_Base = tools::toTitleCase(Preferencia_Base)
  ) %>%
  dplyr::select(
    Preferencia_Base,
    `Frecuencia_Sí`, `Porcentaje_Sí`,
    `Frecuencia_No`, `Porcentaje_No`
  )


# Fila de Total
df_total <- data.frame(
  Preferencia_Base = "Total",
  Frecuencia_Sí = sum(df_tabla_temp$Frecuencia_Sí),
  Porcentaje_Sí = NA, # No se suma, sería engañoso
  Frecuencia_No = sum(df_tabla_temp$Frecuencia_No),
  Porcentaje_No = NA # No se suma, sería engañoso
)

# Unir el data frame con la fila total
df_tabla_final <- bind_rows(df_tabla_temp, df_total)


# Generación de la tabla (flextable)
ft_si_no <- flextable::flextable(df_tabla_final) %>%
  
  # Añadir Título
  flextable::set_caption(caption = "Tabla 8. Distribución de Frecuencias (Sí/No) para Preferencia Base") %>%
  
  # Renombrar cabeceras (se usan para la segunda fila de la cabecera)
  flextable::set_header_labels(
    Preferencia_Base = "Preferencia Base",
    Frecuencia_Sí = "Frecuencia (n)",
    Porcentaje_Sí = "Porcentaje",
    Frecuencia_No = "Frecuencia (n)",
    Porcentaje_No = "Porcentaje"
  ) %>%
  
  # Agrupar las columnas 'Sí' y 'No' en una fila superior
  flextable::add_header_row(
    values = c(" ", "SÍ", "NO"),
    colwidths = c(1, 2, 2)
  ) %>%
  
  # Formato y Tema
  flextable::colformat_double(j = c(3, 5), digits = 1, suffix = "%", na_str = "") %>% 
  
  flextable::theme_booktabs() %>% 
  
  # Alineación
  # Aplicar negrita y bordes a la fila "Total" (la última fila)
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% 
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Alineación
  flextable::align(align = "center", part = "all") %>%
  flextable::align(j = 1, align = "left", part = "body") %>%
  
  # Ajustar
  flextable::autofit()

# Mostrar la tabla
ft_si_no
```

#### `f_Preferencia.Proteina`

Las categorías de `f_Preferencia.Proteina` hacen referencia a las proteínas que los encuestados utilizarían pondrían en sus ensaladas.
Es importante destacar que esta variable proviene de una pregunta con respuesta múltiple por lo que optamos por un gráfico de barras múltiple basándonos en si ha se ha seleccionado cada respuesta o no.

```{r P14-barras, fig.height=6, fig.width=10}
# Definir las variables a analizar (P10: Situaciones de Uso)
multi_vars <- c("f_Prot.Pollo", "f_Prot.Pescado", "f_Prot.Huevo", "f_Prot.Queso", "f_Prot.Tofu", "f_Prot.Marisco", "f_Prot.Carne")

# Transformar a formato largo y contar frecuencias de SÍ/NO
df_barras_dobles <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Prerencia_Proteina", 
    values_to = "Respuesta"
  ) %>%
  dplyr::count(Prerencia_Proteina, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Prerencia_Proteina = gsub("f_Prot.", "", Prerencia_Proteina, fixed = TRUE),
    Prerencia_Proteina = tools::toTitleCase(Prerencia_Proteina),
    Respuesta = factor(Respuesta, levels = c("No", "Sí")) 
  )

# Generación del Gráfico de Barras Agrupadas (Horizontal)
ggplot(df_barras_dobles, aes(x = Prerencia_Proteina, y = Frecuencia, fill = Respuesta)) +
  
  # Barras agrupadas
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) + 
  
  # Etiquetas de Frecuencia
  geom_text(
    aes(label = Frecuencia),
    position = position_dodge(width = 0.9),
    hjust = -0.2, # Mueve la etiqueta -0.2 unidades a lo largo del eje X (separa de la barra)
    size = 3.5
  ) +
  
  # Títulos y Ejes
  labs(
    title = "Figura 9. Gráfico de barras (Sí/No) por Preferencia de Proteínas",
    x = "Preferencia de Proteínas",
    y = "Número de Respuestas",
    fill = "Pondría"
  ) +
  
  # Colores
  scale_fill_manual(values = c("No" = "#a6cee3", "Sí" = "#1f78b4")) + 
  
  # Invertir coordenadas para hacerlo horizontal
  coord_flip() + 
  
  # Ajuste del eje para que no se corten las etiquetas (Aumentamos el espacio)
  scale_y_continuous(expand = expansion(mult = c(0, 0.20))) + 
  
  # Ajuste de Tema
  theme(legend.position = "bottom")
```

Se observa que la proteína que más se pondría en la ensalada sería pollo (con 40 respuestas afirmativas), seguido de huevo (con 29 respuestas afirmativas).

```{r P14-tabla}
# Transformar a formato largo, contar frecuencias de SÍ/NO y calcular porcentajes
df_tabla_temp <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Preferencia_Proteina_Raw", 
    values_to = "Respuesta" 
  ) %>%
  dplyr::count(Preferencia_Proteina_Raw, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Porcentaje = (Frecuencia / n.filas) * 100
  ) %>%
  tidyr::pivot_wider(
    names_from = Respuesta, 
    values_from = c(Frecuencia, Porcentaje),
    values_fill = 0 
  ) %>%
  dplyr::mutate(
    Preferencia_Proteina = gsub("f_Prot.", "", Preferencia_Proteina_Raw, fixed = TRUE),
    Preferencia_Proteina = tools::toTitleCase(Preferencia_Proteina)
  ) %>%
  dplyr::select(
    Preferencia_Proteina,
    `Frecuencia_Sí`, `Porcentaje_Sí`,
    `Frecuencia_No`, `Porcentaje_No`
  )


# Fila de Total
df_total <- data.frame(
  Preferencia_Proteina = "Total",
  Frecuencia_Sí = sum(df_tabla_temp$Frecuencia_Sí),
  Porcentaje_Sí = NA, # No se suma, sería engañoso
  Frecuencia_No = sum(df_tabla_temp$Frecuencia_No),
  Porcentaje_No = NA # No se suma, sería engañoso
)

# Unir el data frame con la fila total
df_tabla_final <- bind_rows(df_tabla_temp, df_total)


# Generación de la tabla (flextable)
ft_si_no <- flextable::flextable(df_tabla_final) %>%
  
  # Añadir Título
  flextable::set_caption(caption = "Tabla 9. Distribución de Frecuencias (Sí/No) para Preferencia de Proteína") %>%
  
  # Renombrar cabeceras (se usan para la segunda fila de la cabecera)
  flextable::set_header_labels(
    Preferencia_Proteina = "Preferencia de Proteína",
    Frecuencia_Sí = "Frecuencia (n)",
    Porcentaje_Sí = "Porcentaje",
    Frecuencia_No = "Frecuencia (n)",
    Porcentaje_No = "Porcentaje"
  ) %>%
  
  # Agrupar las columnas 'Sí' y 'No' en una fila superior
  flextable::add_header_row(
    values = c(" ", "SÍ", "NO"),
    colwidths = c(1, 2, 2)
  ) %>%
  
  # Formato y Tema
  flextable::colformat_double(j = c(3, 5), digits = 1, suffix = "%", na_str = "") %>% 
  
  flextable::theme_booktabs() %>% 
  
  # Alineación
  # Aplicar negrita y bordes a la fila "Total" (la última fila)
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% 
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Alineación
  flextable::align(align = "center", part = "all") %>%
  flextable::align(j = 1, align = "left", part = "body") %>%
  
  # Ajustar
  flextable::autofit()

# Mostrar la tabla
ft_si_no
```

#### 'f_Preferencia.Complementos'

Las categorías de `f_Preferencia.Complementos` hacen referencia a los complementos que los encuestados añadirían a sus ensaladas.
Es importante destacar que esta variable proviene de una pregunta con respuesta múltiple por lo que optamos por un gráfico de barras múltiple basándonos en si ha se ha seleccionado cada respuesta o no.

```{r P15-barras, fig.height=6, fig.width=10}
# Definir las variables a analizar (P10: Situaciones de Uso)
multi_vars <- c("f_Complem.Frutas", "f_Complem.Secos", "f_Complem.Verduras", "f_Complem.Salsas", "f_Complem.Especias")

# Transformar a formato largo y contar frecuencias de SÍ/NO
df_barras_dobles <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Preferenica_Complementos", 
    values_to = "Respuesta"
  ) %>%
  dplyr::count(Preferenica_Complementos, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Preferenica_Complementos = gsub("f_Complem.", "", Preferenica_Complementos, fixed = TRUE),
    Preferenica_Complementos = tools::toTitleCase(Preferenica_Complementos),
    Respuesta = factor(Respuesta, levels = c("No", "Sí")) 
  )

# Generación del Gráfico de Barras Agrupadas (Horizontal)
ggplot(df_barras_dobles, aes(x = Preferenica_Complementos, y = Frecuencia, fill = Respuesta)) +
  
  # Barras agrupadas
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) + 
  
  # Etiquetas de Frecuencia
  geom_text(
    aes(label = Frecuencia),
    position = position_dodge(width = 0.9),
    hjust = -0.2, # Mueve la etiqueta -0.2 unidades a lo largo del eje X (separa de la barra)
    size = 3.5
  ) +
  
  # Títulos y Ejes
  labs(
    title = "Figura 10. Gráfico de barras (Sí/No) por Preferencia Complementos",
    x = "Preferencia Complementos",
    y = "Número de Respuestas",
    fill = "Pondría"
  ) +
  
  # Colores
  scale_fill_manual(values = c("No" = "#a6cee3", "Sí" = "#1f78b4")) + 
  
  # Invertir coordenadas para hacerlo horizontal
  coord_flip() + 
  
  # Ajuste del eje para que no se corten las etiquetas (Aumentamos el espacio)
  scale_y_continuous(expand = expansion(mult = c(0, 0.20))) + 
  
  # Ajuste de Tema
  theme(legend.position = "bottom")
```

Se observa que el complemento que más se pondría en la ensalada sería frutos secos (con 37 respuestas afirmativas), seguido de verduras cocinadas (con 27 respuestas de afirmativas).

```{r P15-tabla}
# Transformar a formato largo, contar frecuencias de SÍ/NO y calcular porcentajes
df_tabla_temp <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Preferenica_Complementos_Raw", 
    values_to = "Respuesta" 
  ) %>%
  dplyr::count(Preferenica_Complementos_Raw, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Porcentaje = (Frecuencia / n.filas) * 100
  ) %>%
  tidyr::pivot_wider(
    names_from = Respuesta, 
    values_from = c(Frecuencia, Porcentaje),
    values_fill = 0 
  ) %>%
  dplyr::mutate(
    Preferenica_Complementos = gsub("f_Complem.", "", Preferenica_Complementos_Raw, fixed = TRUE),
    Preferenica_Complementos = tools::toTitleCase(Preferenica_Complementos)
  ) %>%
  dplyr::select(
    Preferenica_Complementos,
    `Frecuencia_Sí`, `Porcentaje_Sí`,
    `Frecuencia_No`, `Porcentaje_No`
  )


# Fila de Total
df_total <- data.frame(
  Preferenica_Complementos = "Total",
  Frecuencia_Sí = sum(df_tabla_temp$Frecuencia_Sí),
  Porcentaje_Sí = NA, # No se suma, sería engañoso
  Frecuencia_No = sum(df_tabla_temp$Frecuencia_No),
  Porcentaje_No = NA # No se suma, sería engañoso
)

# Unir el data frame con la fila total
df_tabla_final <- bind_rows(df_tabla_temp, df_total)


# Generación de la tabla (flextable)
ft_si_no <- flextable::flextable(df_tabla_final) %>%
  
  # Añadir Título
  flextable::set_caption(caption = "Tabla 10. Distribución de Frecuencias (Sí/No) para Preferencia de Complementos") %>%
  
  # Renombrar cabeceras (se usan para la segunda fila de la cabecera)
  flextable::set_header_labels(
    Preferenica_Complementos = "Preferencia Complementos",
    Frecuencia_Sí = "Frecuencia (n)",
    Porcentaje_Sí = "Porcentaje",
    Frecuencia_No = "Frecuencia (n)",
    Porcentaje_No = "Porcentaje"
  ) %>%
  
  # Agrupar las columnas 'Sí' y 'No' en una fila superior
  flextable::add_header_row(
    values = c(" ", "SÍ", "NO"),
    colwidths = c(1, 2, 2)
  ) %>%
  
  # Formato y Tema
  flextable::colformat_double(j = c(3, 5), digits = 1, suffix = "%", na_str = "") %>% 
  
  flextable::theme_booktabs() %>% 
  
  # Alineación
  # Aplicar negrita y bordes a la fila "Total" (la última fila)
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% 
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Alineación
  flextable::align(align = "center", part = "all") %>%
  flextable::align(j = 1, align = "left", part = "body") %>%
  
  # Ajustar
  flextable::autofit()

# Mostrar la tabla
ft_si_no
```

#### `f_Preferencia.Dispensacion`

Las categorías de `f_Preferencia.Dispensacion`hacen referencia a los 3 formatos de dispensación presentados para la barra de ensaladas.
Se trata de una variable cuyas categorías no guardan una relación de orden entre sí.

```{r P18-tarta}
# Crear el data frame de frecuencias y porcentajes usando dplyr
datos_grafico <- datos %>%
  # Contar la frecuencia de cada nivel de la variable f_Preferencia.Dispensacion
  count(f_Preferencia.Dispensacion, name = "Frecuencia") %>%
  # Calcular el porcentaje y el texto de la etiqueta
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Etiquetas = paste0(f_Preferencia.Dispensacion, "\n(", round(Porcentaje, 1), "%)") # Etiqueta para el gráfico
  ) %>%
  # Eliminar filas con 0% si existen, y categorías no deseadas
  filter(Porcentaje > 0 & f_Preferencia.Dispensacion != "Total") # Se filtra 'Total' aunque dplyr no lo añade

# Usamos el vector de Porcentaje para el tamaño de las porciones
pie(datos_grafico$Porcentaje,
    # Usamos las Etiquetas que combinan nombre y porcentaje
    labels = datos_grafico$Etiquetas,
    # Título
    main = 'Figura 11. Preferencia del Formato de Dispensación',
    # Asignar un color diferente a cada porción
    col = RColorBrewer::brewer.pal(n = nrow(datos_grafico), name = "Set3"))

```

Se observa que el formato de dispensación preferido es que tiene protección fija y los ingredientes no son accesibles (con el 38.1%), seguido del formato en el que los ingredientes esta protegidos por una mampara de cristal que se abre (con el34.9&)

```{r P18-tabla}
# Preparación de datos
df_tabla_dispensacion <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Preferencia.Dispensacion, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Preferencia.Dispensacion = "Total",
  Frecuencia = sum(df_tabla_dispensacion$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_dispensacion, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 11. Distribución de frecuencias para Formato de Dispensación Preferido") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Preferencia.Dispensacion = "Formato de Dispensación",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Intencion.Uso`

Las categorías de `f_Intencion.Uso` hacen referencia a si los encuestados utilizarían nuestra barra de ensaladas o no (grado de aceptación).
Se trata de una variable cuyas categorías no guardan una relación de orden entre sí.

```{r P19-tarta}
# Crear el data frame de frecuencias y porcentajes usando dplyr
datos_grafico <- datos %>%
  # Contar la frecuencia de cada nivel de la variable f_Intencion.Uso
  count(f_Intencion.Uso, name = "Frecuencia") %>%
  # Calcular el porcentaje y el texto de la etiqueta
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Etiquetas = paste0(f_Intencion.Uso, "\n(", round(Porcentaje, 1), "%)") # Etiqueta para el gráfico
  ) %>%
  # Eliminar filas con 0% si existen, y categorías no deseadas
  filter(Porcentaje > 0 & f_Intencion.Uso != "Total") # Se filtra 'Total' aunque dplyr no lo añade

# Usamos el vector de Porcentaje para el tamaño de las porciones
pie(datos_grafico$Porcentaje,
    # Usamos las Etiquetas que combinan nombre y porcentaje
    labels = datos_grafico$Etiquetas,
    # Título
    main = 'Figura 12. Grado de Aceptación',
    # Asignar un color diferente a cada porción
    col = RColorBrewer::brewer.pal(n = nrow(datos_grafico), name = "Set3"))

```

Podemos concluir que la mayoría de los encuestados aceptarían el producto y lo usarían, siendo del 73%.

```{r P19-tabla}
# Preparación de datos
df_tabla_aceptacion <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Intencion.Uso, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Intencion.Uso = "Total",
  Frecuencia = sum(df_tabla_aceptacion$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_aceptacion, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 12. Distribución de frecuencias para el Grado de Aceptación") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Intencion.Uso = "Grado de Aceptación",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Genero`

Las categorías de `f_Genero` diferencia el género del encuestado.
Se trata de una variable cuyas categorías no guardan una relación de orden entre sí.

```{r P21-tarta}
# Crear el data frame de frecuencias y porcentajes usando dplyr
datos_grafico <- datos %>%
  # Contar la frecuencia de cada nivel de la variable f_Genero
  count(f_Genero, name = "Frecuencia") %>%
  # Calcular el porcentaje y el texto de la etiqueta
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Etiquetas = paste0(f_Genero, "\n(", round(Porcentaje, 1), "%)") # Etiqueta para el gráfico
  ) %>%
  # Eliminar filas con 0% si existen, y categorías no deseadas
  filter(Porcentaje > 0 & f_Genero != "Total") # Se filtra 'Total' aunque dplyr no lo añade

# Usamos el vector de Porcentaje para el tamaño de las porciones
pie(datos_grafico$Porcentaje,
    # Usamos las Etiquetas que combinan nombre y porcentaje
    labels = datos_grafico$Etiquetas,
    # Título
    main = 'Figura 13. Género',
    # Asignar un color diferente a cada porción
    col = RColorBrewer::brewer.pal(n = nrow(datos_grafico), name = "Set3"))

```

Se puede observar que la mayoría de los encuestados son hombres con un 50.8%, mientras que las mujeres representan el 46% de la respuestas.

```{r P21-tabla}
# Preparación de datos
df_tabla_genero <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Genero, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Genero = "Total",
  Frecuencia = sum(df_tabla_genero$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_genero, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 13. Distribución de frecuencias para Género") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Genero = "Género",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Situacion.Laboral`

Las categorías de `f_Situacion.Laboral` indican la situación laboral del encuestado.
Se trata de una variable cuyas categorías no guardan una relación de orden entre sí.

```{r P23-tarta}
# Crear el data frame de frecuencias y porcentajes usando dplyr
datos_grafico <- datos %>%
  # Contar la frecuencia de cada nivel de la variable f_Situacion.Laboral
  count(f_Situacion.Laboral, name = "Frecuencia") %>%
  # Calcular el porcentaje y el texto de la etiqueta
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Etiquetas = paste0(f_Situacion.Laboral, "\n(", round(Porcentaje, 1), "%)") # Etiqueta para el gráfico
  ) %>%
  # Eliminar filas con 0% si existen, y categorías no deseadas
  filter(Porcentaje > 0 & f_Situacion.Laboral != "Total") # Se filtra 'Total' aunque dplyr no lo añade

# Usamos el vector de Porcentaje para el tamaño de las porciones
pie(datos_grafico$Porcentaje,
    # Usamos las Etiquetas que combinan nombre y porcentaje
    labels = datos_grafico$Etiquetas,
    # Título
    main = 'Figura 14. Situación Laboral',
    # Asignar un color diferente a cada porción
    col = RColorBrewer::brewer.pal(n = nrow(datos_grafico), name = "Set3"))

```

Se observa que la mayoría de encuestados son estudiantes(con un 61,9%), seguidos de trabajadores por cuenta ajena (con un 25,4%).

```{r P23-tabla}
# Preparación de datos
df_tabla_laboral <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Situacion.Laboral, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Situacion.Laboral = "Total",
  Frecuencia = sum(df_tabla_laboral$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_laboral, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 14. Distribución de frecuencias para Situación Laboral") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Situacion.Laboral = "Situación Laboral",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

### Caso de variables con categorías ordenadas

#### `f_Frecuencia`

Las categorías de `f_Frecuencia` miden la frecuencia con la que los encuestados comer fuera de casa.
La variable tiene 5 categorías, que se ordenan desde menos tiempo a más tiempo: Nunca, Rara/Ocasionalmente, 1-2 veces por semana, 3-4 veces por semana y más de 5 veces por semana.
Este orden se fijó mediante el parámetro levels de la instrucción factor().

```{r P2-barra, fig.height=6}
df_frecuencia_tiempo <- datos %>%
  # Contar la frecuencia de cada nivel (respeta el orden del factor f_Frecuencia)
  dplyr::count(f_Frecuencia, name = "Frecuencia") %>%
  
  # Calcular porcentajes y porcentaje acumulado
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Porcentaje_Acumulado = cumsum(Porcentaje)
  ) %>%
  
  dplyr::mutate(
    Porcentaje = round(Porcentaje, 1), # Redondeado a 1 decimal
    Porcentaje_Acumulado = round(Porcentaje_Acumulado, 1)
  )


# Generación del gráfico de barras
ggplot(df_frecuencia_tiempo, aes(x = f_Frecuencia, y = Frecuencia)) +
  # Barras
  geom_bar(stat = "identity", fill = "#1f78b4") +
  
  # Etiquetas de Porcentaje sobre las barras
  geom_text(aes(label = paste0(Porcentaje, "%")), 
            vjust = -0.5, # Ajuste vertical para que quede sobre la barra
            size = 4) +
  
  # Títulos y Ejes
  labs(
    title = 'Figura 15. Frecuencia de Comer Fuera de Casa',
    x = "Frecuencia",
    y = "Numero de respuestas"
  ) +
  
  # Corrección del eje Y para evitar el recorte de las etiquetas
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

Se observa que la mayoría de los encuestados salen a comer fuera de casa entre 1 y 2 veces por semana (con un 34.9%).
También se observa que el gráfico tiene una ligera asimetría a la derecha.

```{r P2-tabla}
# Preparación de datos
df_tabla_freq <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Frecuencia, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Frecuencia = "Total",
  Frecuencia = sum(df_tabla_freq$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_freq, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 15. Distribución de frecuencias para Frecuencia de Comer Fuera de Casa") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Frecuencia = "Frecuencia de comer fuera de casa",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Frecuncia.Comida.Preparada`

Las categorías de `f_Frecuencia.Comida.Preparada` miden la frecuencia con la que los encuestados compran comida preparada en un supermercado.
La variable tiene 5 categorías, que se ordenan desde menos tiempo a más tiempo: Nunca, Rara/Ocasionalmente, 1-2 veces por semana, 3-4 veces por semana y más de 5 veces por semana.
Este orden se fijó mediante el parámetro levels de la instrucción factor().

```{r P5-barra, fig.height=6}
df_frecuencia_tiempo <- datos %>%
  # Contar la frecuencia de cada nivel (respeta el orden del factor f_Frecuencia.Comida.Preparada)
  dplyr::count(f_Frecuencia.Comida.Preparada, name = "Frecuencia") %>%
  
  # Calcular porcentajes y porcentaje acumulado
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Porcentaje_Acumulado = cumsum(Porcentaje)
  ) %>%
  
  dplyr::mutate(
    Porcentaje = round(Porcentaje, 1), # Redondeado a 1 decimal
    Porcentaje_Acumulado = round(Porcentaje_Acumulado, 1)
  )


# Generación del gráfico de barras
ggplot(df_frecuencia_tiempo, aes(x = f_Frecuencia.Comida.Preparada, y = Frecuencia)) +
  # Barras
  geom_bar(stat = "identity", fill = "#1f78b4") +
  
  # Etiquetas de Porcentaje sobre las barras
  geom_text(aes(label = paste0(Porcentaje, "%")), 
            vjust = -0.5, # Ajuste vertical para que quede sobre la barra
            size = 4) +
  
  # Títulos y Ejes
  labs(
    title = 'Figura 16. Frecuencia de Comprar Comida Preparada en Supermercados',
    x = "Frecuencia de Comprar Comida Preparada en Supermercados",
    y = "Numero de respuestas"
  ) +
  
  # Corrección del eje Y para evitar el recorte de las etiquetas
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

Se observa que la mayoría de encuestados compran ocasionalmante comida preparada en supermercados (con un 36.5%), seguido de que los que directamente no compran o rara vez lo hacen (con un 34.9%).

```{r P5-tabla}
# Preparación de datos
df_tabla_freq_prep <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Frecuencia.Comida.Preparada, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Frecuencia.Comida.Preparada = "Total",
  Frecuencia = sum(df_tabla_freq_prep$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_freq_prep, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 16. Distribución de frecuencias para Frecuencia de Comprar Comida Preparada en un Supermercado") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Frecuencia.Comida.Preparada = "Frecuencia de comprar comida preparada en un supermercado",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

\####`f_Disposicion.Pago` Las categorías de `f_Disposicion.Pago` miden la disposición a pagar de los encuestados por las ensaladas de la barra.
La variable tiene 5 categorías, que se ordenan desde menos dinero a más dinero: Menos de 4€, Entre 4 y 5,49€, Entre 5,50 y 7€, Entre 7 y 9,50€ y más de 9,50€.
Este orden se fijó mediante el parámetro levels de la instrucción factor().

```{r P16-barra, fig.height=6}
df_frecuencia_tiempo <- datos %>%
  # Contar la frecuencia de cada nivel (respeta el orden del factor f_Disposicion.Pago)
  dplyr::count(f_Disposicion.Pago, name = "Frecuencia") %>%
  
  # Calcular porcentajes y porcentaje acumulado
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Porcentaje_Acumulado = cumsum(Porcentaje)
  ) %>%
  
  dplyr::mutate(
    Porcentaje = round(Porcentaje, 1), # Redondeado a 1 decimal
    Porcentaje_Acumulado = round(Porcentaje_Acumulado, 1)
  )


# Generación del gráfico de barras
ggplot(df_frecuencia_tiempo, aes(x = f_Disposicion.Pago, y = Frecuencia)) +
  # Barras
  geom_bar(stat = "identity", fill = "#1f78b4") +
  
  # Etiquetas de Porcentaje sobre las barras
  geom_text(aes(label = paste0(Porcentaje, "%")), 
            vjust = -0.5, # Ajuste vertical para que quede sobre la barra
            size = 4) +
  
  # Títulos y Ejes
  labs(
    title = 'Figura 17. Disposición a Pagar',
    x = "Disposición a Pagar",
    y = "Numero de respuestas"
  ) +
  
  # Corrección del eje Y para evitar el recorte de las etiquetas
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

Se observa que la mayoría de los encuestados estan dispuestos a pagar entre 4 y 5,50€ (con un 41.3%), seguido de los que estan dispuestos a pagar entre 5,50 y 7€ (con un 28.6%).

```{r P16-tabla}
# Preparación de datos
df_tabla_disp <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Disposicion.Pago, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Disposicion.Pago = "Total",
  Frecuencia = sum(df_tabla_disp$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_disp, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 17. Distribución de frecuencias para la Disposición a Pagar") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Disposicion.Pago = "Disposición a Pagar",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f.Edad`

Las categorías de `f_Edad` miden la edad de los encuestados.
La variable tiene 5 categorías, que se ordenan desde menor a edad a más edad: Menos de 18, Entre 18-24 años, Entre 25-44 años, Entre 45-64 años y más de 65 años.
Este orden se fijó mediante el parámetro levels de la instrucción factor().

```{r P20-barra, fig.height=6}
df_frecuencia_tiempo <- datos %>%
  # Contar la frecuencia de cada nivel (respeta el orden del factor f_Edad)
  dplyr::count(f_Edad, name = "Frecuencia") %>%
  
  # Calcular porcentajes y porcentaje acumulado
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Porcentaje_Acumulado = cumsum(Porcentaje)
  ) %>%
  
  dplyr::mutate(
    Porcentaje = round(Porcentaje, 1), # Redondeado a 1 decimal
    Porcentaje_Acumulado = round(Porcentaje_Acumulado, 1)
  )


# Generación del gráfico de barras
ggplot(df_frecuencia_tiempo, aes(x = f_Edad, y = Frecuencia)) +
  # Barras
  geom_bar(stat = "identity", fill = "#1f78b4") +
  
  # Etiquetas de Porcentaje sobre las barras
  geom_text(aes(label = paste0(Porcentaje, "%")), 
            vjust = -0.5, # Ajuste vertical para que quede sobre la barra
            size = 4) +
  
  # Títulos y Ejes
  labs(
    title = 'Figura 18. Edad',
    x = "Edad",
    y = "Numero de respuestas"
  ) +
  
  # Corrección del eje Y para evitar el recorte de las etiquetas
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

Se observa que la edad de la mayoría de los encuestados se encuentra entre 18 y 24 años (con un 63.5%), seguido del rango de edades entre 45 y 64 años (con un 19%).

```{r P20-tabla}
# Preparación de datos
df_tabla_edad <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Edad, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Edad = "Total",
  Frecuencia = sum(df_tabla_edad$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_edad, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 18. Distribución de frecuencias por Edad") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Edad = "Edad",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Nivel.Educativo`

Las categorías de `f_Nivel.Educativo` miden el nivel educativo máximo alcanzado de los encuestados.
La variable tiene 4 categorías, que se ordenan desde menos nivel a más nivel: ESO, FP medio/Bachillerato, FP superior y Universitario.
Este orden se fijó mediante el parámetro levels de la instrucción factor().

```{r P22-barra, fig.height=6}
df_frecuencia_tiempo <- datos %>%
  # Contar la frecuencia de cada nivel (respeta el orden del factor f_Nivel.Educativo)
  dplyr::count(f_Nivel.Educativo, name = "Frecuencia") %>%
  
  # Calcular porcentajes y porcentaje acumulado
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Porcentaje_Acumulado = cumsum(Porcentaje)
  ) %>%
  
  dplyr::mutate(
    Porcentaje = round(Porcentaje, 1), # Redondeado a 1 decimal
    Porcentaje_Acumulado = round(Porcentaje_Acumulado, 1)
  )


# Generación del gráfico de barras
ggplot(df_frecuencia_tiempo, aes(x = f_Nivel.Educativo, y = Frecuencia)) +
  # Barras
  geom_bar(stat = "identity", fill = "#1f78b4") +
  
  # Etiquetas de Porcentaje sobre las barras
  geom_text(aes(label = paste0(Porcentaje, "%")), 
            vjust = -0.5, # Ajuste vertical para que quede sobre la barra
            size = 4) +
  
  # Títulos y Ejes
  labs(
    title = 'Figura 19. Nivel Educativo Máximo Alcanzado',
    x = "Nivel Educativo",
    y = "Numero de respuestas"
  ) +
  
  # Corrección del eje Y para evitar el recorte de las etiquetas
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

Se observa que el nivel educativo alcanzado por la mayoría de encuestados es el universitario (con un 61.9%), seguido de encuestados con nivel máximo alcanzado de bachillerato o FP media (con un 20.6%).

```{r P22-tabla}
# Preparación de datos
df_tabla_edu <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Nivel.Educativo, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Nivel.Educativo = "Total",
  Frecuencia = sum(df_tabla_edu$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_edu, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 19. Distribución de frecuencias para Nivel Educativo Máximo Alcanzado") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Nivel.Educativo = "Nivel Educativo Máximo Alcanzado",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

## Variables númericas

### Figuras de las variables de escala Likert

La representación de las variables con escala Likert resulta más visual con un diagrama de barras acumulado:

```{r P7-P12-P17-likert, fig.height=8, fig.width=10}
# 1. Definir los vectores de variables y etiquetas para mayor claridad

# Variables de escala Likert (factores)
likert_factors <- c(
  "f_Importancia.Saludable", 
  "f_Imp.Sostenibilidad", "f_Imp.Origen.Local", "f_Imp.Variedad", 
  "f_Imp.Sabor", "f_Imp.Precio", "f_Imp.Higiene", "f_Imp.Rapidez", 
  "f_Aptitud.Social"
)

# Etiquetas descriptivas correspondientes para el gráfico (Eje Y)
likert_labels <- c(
  'Me importa comer saludable',
  'Doy importancia a la sostenibilidad',
  'Doy importancia a productos de origen local',
  'Doy importancia a la variedad de ingredientes',
  'Doy importancia al sabor',
  'Doy importancia al precio',
  'Doy importancia a la higiene',
  'Doy importancia a la rapidez',
  'Considero las ensaladas una comida social'
)


# 2. SELECCIONAR DATOS (Sustitución de variables)
datos.likert <- datos[likert_factors]

# 3. CAMBIAR EL NOMBRE DE LAS COLUMNAS para que aparezcan las afirmaciones evaluadas
names(datos.likert) <- likert_labels

# 4. GENERAR LA FIGURA
# Se mantiene 'likert.bar.plot' y 'centered = FALSE' para replicar el formato del profesor
fig.likert <- likert::likert.bar.plot(
  likert::likert(datos.likert),
  
  # Orden de los ítems (se mantiene el orden de las etiquetas)
  group.order = likert_labels,      
  
  # Configuración para hacer un gráfico de barras apiladas simple (NO divergente)
  centered = FALSE,
  plot.percent.low = FALSE,
  plot.percent.high = FALSE,
  plot.percent.neutral = FALSE,
  
  # Leyenda que explica las respuestas
  legend.position = 'right',
  legend = 'Respuesta (1-5)'
) +
  # Título de la figura (Actualizado)
  labs(
    title = 'Figura 20. Valoración de Factores de Importancia (Escala 1-5)',
    y = 'Porcentaje (%)',
    x = NULL
  )

# Imprimimos la figura
fig.likert

```

Según la valoración de los factores de importancia en una escala Likert, existe una clara jerarquía de prioridades: los aspectos más cruciales son la Higiene, el Sabor y el Precio, ya que la inmensa mayoría de los encuestados los considera "muy importantes" (categorías 4 y 5); les siguen en importancia la Variedad de Ingredientes, el Origen Local y el valor de Comer Saludable.
Por otro lado, la Sostenibilidad es el factor que recibe la mayor proporción de valoraciones bajas en comparación con los demás, y la Rapidez también muestra una importancia variable.
Finalmente, una conclusión de opinión destacada es que la mayoría de los encuestados no percibe las ensaladas como una comida social.

## Variables cualitativas

La variable `Mala.Experiencia.Descripcion` se ha registrado mediante una pregunta abierta.
El motivo de que fuera abierta, sin que se proporcionara un conjunto cerrado de respuestas, es que se quiere conocer con un poco más de detalle algunas experiencias negativas previas para relacionarla con el grado de aceptación.
Por tanto, se trata de una variable cualitativa, y por este motivo se planteó en forma de pregunta abierta.

Este tipo de variables no puede ser tratada estadísticamente.
Su análisis tiene que llevarse a cabo de forma manual.
Lo que sí vamos a hacer es seleccionar las respuestas válidas mediante R para después proceder a su análisis cualitativo

```{r}
# generamos una tabla con las filas que contienen alguna razón para no usar el escáner
datos.cualitativos <- drop_na(datos, 'Mala.Experiencia.Descripcion')

# imprimimos únicamente esa columna
flextable(
  # convertimos a un dataframe
  as.data.frame(datos.cualitativos$Mala.Experiencia.Descripcion)) %>% 
  # establecemos el título de la tabla
  set_caption('Tabla 20. Malas experiencias con comida preparada o autoservicio.') %>%
  # ajustamos la tabla para que pueda leerse mejor en la página
  autofit()
```

Hemos optado por agrupar las respuestas por categorías para poder analizarlas en mayor profundidad.
Nos hemos decantado por 7 categorías: 1.
No han tenido malas experiencias.
2.
Relacionadas con la higiene, salud y contaminación.
3.
Relacionadas con la frescura y calidad.
4.
Relacionadas con el sabor y la preparación.
5.
Relacionadas con el servicio y la logística detrás de este.
6.
Relacionadas con la variedad de ingredientes y la cantidad de porción.
7.
Otros (no queda claro donde categorizarlas).

```{r p9_Categorizacion_Cualitativa}
# 1. Aplicamos la categorización DIRECTAMENTE sobre el dataframe 'datos'
datos <- datos %>%
  dplyr::mutate(
    # Creamos la nueva variable y la guardamos en 'datos' para usarla luego
    Categoria_Mala_Exp = dplyr::case_when(
      
      # Si está vacío (NA), asumimos que no hay queja
      is.na(Mala.Experiencia.Descripcion) ~ "No Mala Experiencia",
      
      # Higiene, Salud y Contaminación
      stringr::str_detect(Mala.Experiencia.Descripcion, stringr::regex("gusano|intoxique|madera|higiene|sanitario|contaminacion|Sibo|saludables", ignore_case = TRUE)) ~ "Higiene / Contaminación / Salud",
      
      # Frescura y Calidad
      stringr::str_detect(Mala.Experiencia.Descripcion, stringr::regex("frescura|fresco|deteriorado|mal estado|mala pinta|fría|baja", ignore_case = TRUE)) ~ "Calidad / Frescura",
      
      # Sabor y Preparación
      stringr::str_detect(Mala.Experiencia.Descripcion, stringr::regex("grasienta|mal preparada|congelada|cartón|química|saben|caras", ignore_case = TRUE)) ~ "Sabor / Preparación",
      
      # Variedad y Porción
      stringr::str_detect(Mala.Experiencia.Descripcion, stringr::regex("poca variedad|mucha lechuga|poco condumio|buffet de hoteles", ignore_case = TRUE)) ~ "Variedad / Porción",
      
      # Logística / Servicio
      stringr::str_detect(Mala.Experiencia.Descripcion, stringr::regex("cubiertos|decidir|calentar|problema|lento", ignore_case = TRUE)) ~ "Logística / Servicio",
      
      # No Mala Experiencia (Patrón de texto explícito)
      stringr::str_detect(Mala.Experiencia.Descripcion, stringr::regex("no|ninguna|nunca|recuerdo|previas|prefiero|suelo comer fuera|Pompeya", ignore_case = TRUE)) ~ "No Mala Experiencia",
      
      # Por defecto (Cualquier otra cosa escrita es una queja no categorizada)
      TRUE ~ "Otros (No Categorizado)"
    )
  )

# 2. Generación de la Tabla Resumen (usando la variable recién creada en 'datos')
df_resumen <- datos %>%
  dplyr::count(Categoria_Mala_Exp, name = "Frecuencia") %>%
  dplyr::mutate(
    Porcentaje = (Frecuencia / sum(Frecuencia)) * 100
  ) %>%
  dplyr::arrange(desc(Frecuencia))

# Añadir Fila Total y Formato
df_total <- data.frame(
  Categoria_Mala_Exp = "TOTAL",
  Frecuencia = sum(df_resumen$Frecuencia),
  Porcentaje = 100.0
)
df_resumen_final <- bind_rows(df_resumen, df_total)

# Generación de la tabla visual (flextable)
flextable::flextable(df_resumen_final) %>%
  flextable::set_caption(caption = "Tabla 21. Agrupación de Motivos de Mala Experiencia (Datos Reales).") %>%
  flextable::set_header_labels(
    Categoria_Mala_Exp = "Categoría de Experiencia",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje (%)"
  ) %>%
  flextable::colformat_double(j = 3, digits = 1, suffix = "%") %>%
  flextable::theme_booktabs() %>%
  flextable::bold(i = nrow(df_resumen_final), part = "body") %>%
  flextable::autofit()
```

# Análisis bivariante

## Relacionar la frecuencia con la que la muestra come fuera de casa y el motivo principal

Vamos a comprobar si la frecuencia con el que el encuestado come fuera de casa depende del motivo por el que lo hace.
Primero, inspeccionaremos la distribución de los casos mediante una tabla de contingencia:

```{r}
# tabla de contingencia
proc_freq(datos, 'f_Motivo',
'f_Frecuencia',
 # indicamos qué porcentajes queremos
 include.row_percent = TRUE,
 include.column_percent = FALSE,
 include.table_percent = FALSE) %>%
 # ajustamos los nombres de las variables en la tabla
 compose(i=1, j=1, value = as_paragraph('Motivo'), part =
'header') %>%
 compose(i=1, j=3, value = as_paragraph('Frecuencia'), part =
'header') %>%
 # indicamos el título
 set_caption('Tabla 21. Tabla de contingencia entre el motivo y
la frecuencia.') %>%
 # ajustamos la tabla a la página
 autofit()

```

Se observa que el 50% de los encuestados que comen fuera de casa por un motivo de conveniencia (trabajo, estudios, etc), lo hacen entre 3 y 4 veces por semana.
Además,los encuestados cuyas comidas extradomésticas suelen ser por placer suelen comer fuera de casa ocasionalmente o entre 1 y 2 veces por semana.
Finalmente, el 50% de aquellos cuya razón habitual son razones extraordinarias rara vez comen fuera de casa.
Se aprecia una diferencia de uso entre los distintos grupos y todo lo observado tiene sentido lógico, lo que sugiere que es posible que haya una dependencia.

Para confirmarlo, realizamos un test chi-cuadrado:

```{r}

chisq.test(x=datos$f_Motivo, y=datos$f_Frecuencia)

# test del chi cuadrado
res.chisq <- chisq_test(
 x = datos$f_Motivo,
 y = datos$f_Frecuencia)
# resultado de la evaluación
res.chisq %>%
 # imprimimos la tabla
 flextable() %>%
 # indicamos el título
 set_caption('Tabla 22. Resultados del test del chi cuadrado entre el
motivo de comer fuera y la frecuencia.') %>%
 # arreglamos la coma de los decimales y el punto de los miles
 colformat_num(
 j = c("statistic", "p"),
 big.mark = ".",
 decimal.mark = ","
 ) %>%
 # ajustamos la tabla a la página
 autofit()



```

```{r}
# sacamos los estadísticos descriptivos del test
chisq_descriptives(res.chisq) %>%
 # renombramos las columnas x e y
 rename(
 Motivo = 'x',
 Frecuencia = 'y') %>%
 # imprimimos la tabla
 flextable() %>%
 # indicamos el título
 set_caption('Tabla 23. Estadísticos del test del chi cuadrado entre el
motivo y la frecuencia.') %>%
 # arreglamos la coma de los decimales y el punto de los miles
 colformat_num(
 j = c("prop", "row.prop", "col.prop", "expected", "resid",
"std.resid"),
 big.mark = ".",
 decimal.mark = ","
 ) %>%
 # ajustamos la tabla a la página
 autofit()
```

Al consultar la tabla con los estadísticos descriptivos del test observamos que en la columna "expected" hay valores que son menores de 5.
Por tanto el test no puede considerarse válido al no cumplirse una de las condiciones de validez de esta prueba.
Para solucionar este problema, agrupamos las categorías para asegurar que se cumpla esta condición.
En este caso, unificamos las categorías "Nunca/Rara" y "Ocasionalmente", así como "3-4/sem" y "5+/sem".

```{r}
# creamos la nueva variable
datos$f_Frecuencia2 <-
datos$f_Frecuencia
levels(datos$f_Frecuencia2) <- list(
 'Nunca/Ocasional' = c('Nunca/Rara','Ocasional'),
 '1-2/sem' = '1-2/sem',
 '3+/sem' = c('3-4/sem', '5+/sem'))

# tabla de contingencia
proc_freq(datos, 'f_Motivo', 'f_Frecuencia2',
 # indicamos qué porcentajes queremos
 include.row_percent = TRUE,
 include.column_percent = FALSE,
 include.table_percent = FALSE) %>%
 # ajustamos los nombres de las variables en la tabla
 compose(i=1, j=1, value = as_paragraph('Motivo'), part =
'header') %>%
 compose(i=1, j=3, value = as_paragraph('Frecuencia'), part = # Etiqueta de la nueva variable
'header') %>%
 # indicamos el título
 set_caption('Tabla 24. Tabla de contingencia entre el motivo y la frecuencia') %>% # Título ajustado
 # ajustamos la tabla a la página
 autofit()
                   
```

```{r}



# test del chi cuadrado
res.chisq <- chisq_test(
 x = datos$f_Motivo,
 y = datos$f_Frecuencia2)
# resultado de la evaluación
res.chisq %>%
  # imprimimos la tabla
 flextable() %>%
 # indicamos el título
 set_caption('Tabla 25. Resultados del test del chi cuadrado entre el
motivo y la frecuencia') %>%
 # arreglamos la coma de los decimales y el punto de los miles
 colformat_num(
 j = c("statistic", "p"),
 big.mark = ".",
 decimal.mark = ","
 ) %>%
 # ajustamos la tabla a la página
 autofit()
```

```{r}

# sacamos los estadísticos descriptivos del test
chisq_descriptives(res.chisq) %>%
 # renombramos las columnas x e y
 rename(
 Motivo = 'x',
 Frecuencia = 'y') %>%
 # imprimimos la tabla
 flextable() %>%
 # indicamos el título
 set_caption('Tabla 26. Estadísticos del test del chi cuadrado entre el
motivo y la frecuencia.') %>%
 # arreglamos la coma de los decimales y el punto de los miles
 colformat_num(
 j = c("prop", "row.prop", "col.prop", "expected", "resid",
"std.resid"),
 big.mark = ".",
 decimal.mark = ","
 ) %>%
 # ajustamos la tabla a la página
 autofit()
```

Sigue habiendo valores en la columna "expected" menores de 5.
Vamos a agrupar "Nunca/Ocasional" con "1-2/sem".

```{r}
# Creamos la nueva variable
datos$f_Frecuencia3 <- datos$f_Frecuencia

# Definimos los nuevos niveles agrupando como has pedido
levels(datos$f_Frecuencia3) <- list(
  '0-2/sem' = c('Nunca/Rara', 'Ocasional', '1-2/sem'),
  '3+/sem'  = c('3-4/sem', '5+/sem')
)

# Tabla de contingencia
proc_freq(datos, 'f_Motivo', 'f_Frecuencia3',
  include.row_percent = TRUE,
  include.column_percent = FALSE,
  include.table_percent = FALSE) %>%
  compose(i=2, j=1, value = as_paragraph('Motivo'), part = 'header') %>%
  compose(i=1, j=3, value = as_paragraph('Frecuencia (Agrupada)'), part = 'header') %>%
  set_caption('Tabla 27. Tabla de contingencia: Motivo vs Frecuencia (0-2/sem vs 3+/sem)') %>%
  autofit()
```

```{r}

# test del chi cuadrado
res.chisq <- chisq_test(
 x = datos$f_Motivo,
 y = datos$f_Frecuencia3)
# resultado de la evaluación
res.chisq %>%
  # imprimimos la tabla
 flextable() %>%
 # indicamos el título
 set_caption('Tabla 28. Resultados del test del chi cuadrado entre el
motivo y la frecuencia') %>%
 # arreglamos la coma de los decimales y el punto de los miles
 colformat_num(
 j = c("statistic", "p"),
 big.mark = ".",
 decimal.mark = ","
 ) %>%
 # ajustamos la tabla a la página
 autofit()
```

```{r}
# sacamos los estadísticos descriptivos del test
chisq_descriptives(res.chisq) %>%
 # renombramos las columnas x e y
 rename(
 Motivo = 'x',
 Frecuencia = 'y') %>%
 # imprimimos la tabla
 flextable() %>%
 # indicamos el título
 set_caption('Tabla 29. Estadísticos del test del chi cuadrado entre el
motivo y la frecuencia.') %>%
 # arreglamos la coma de los decimales y el punto de los miles
 colformat_num(
 j = c("prop", "row.prop", "col.prop", "expected", "resid",
"std.resid"),
 big.mark = ".",
 decimal.mark = ","
 ) %>%
 # ajustamos la tabla a la página
 autofit()
```

Sigue habiendo valores "expected" \< 5 por tanto volvemos a agrupar, pero esta vez, por motivo, diferenciando “Conveniencia” y “”Social/Placer/Extraordinario”, y volvemos a repetir el proceso.

```{r}
# Creamos la nueva variable
datos$f_Motivo_Binario <- datos$f_Motivo
    levels(datos$f_Motivo_Binario) <- list(
      'Conveniencia' = 'Conveniencia',
      'Ocio/Social/Otros' = c('Social', 'Placer', 'Extraordinario')
)

# Tabla de contingencia
proc_freq(datos, 'f_Motivo_Binario', 'f_Frecuencia3',
  include.row_percent = TRUE,
  include.column_percent = FALSE,
  include.table_percent = FALSE) %>%
  compose(i=1, j=1, value = as_paragraph('Motivo Binario'), part = 'header') %>%
  compose(i=1, j=3, value = as_paragraph('Frecuencia (Agrupada)'), part = 'header') %>%
  set_caption('Tabla 30. Tabla de contingencia: Motivo Binario vs Frecuencia (0-2/sem vs 3+/sem)') %>%
  autofit()
```

```{r}

# test del chi cuadrado
res.chisq <- chisq_test(
 x = datos$f_Motivo_Binario,
 y = datos$f_Frecuencia3)
# resultado de la evaluación
res.chisq %>%
  # imprimimos la tabla
 flextable() %>%
 # indicamos el título
 set_caption('Tabla 31. Resultados del test del chi cuadrado entre el
motivo binario y la frecuencia') %>%
 # arreglamos la coma de los decimales y el punto de los miles
 colformat_num(
 j = c("statistic", "p"),
 big.mark = ".",
 decimal.mark = ","
 ) %>%
 # ajustamos la tabla a la página
 autofit()
```

```{r}
# sacamos los estadísticos descriptivos del test
chisq_descriptives(res.chisq) %>%
 # renombramos las columnas x e y
 rename(
 Motivo = 'x',
 Frecuencia = 'y') %>%
 # imprimimos la tabla
 flextable() %>%
 # indicamos el título
 set_caption('Tabla 32. Estadísticos del test del chi cuadrado entre el
motivo binario y la frecuencia.') %>%
 # arreglamos la coma de los decimales y el punto de los miles
 colformat_num(
 j = c("prop", "row.prop", "col.prop", "expected", "resid",
"std.resid"),
 big.mark = ".",
 decimal.mark = ","
 ) %>%
 # ajustamos la tabla a la página
 autofit()
```

Tras realizar esta última agrupación, se verifica que todos los valores "expected" \> 5.

El p-valor \< 0,05 permite rechazar la hipótesis nula, por consiguiente, se concluye que existe una dependencia entre el motivo y la frecuencia de consumo extradoméstico.
El análisis de las frecuencias relativas por filas revela diferencias estructurales en los perfiles de consumo:

-   **Perfil de Conveniencia**: El 54,2% de los encuestados cuyo motivo es la conveniencia (trabajo, estudios) se sitúa en el rango de alta frecuencia (3 o más veces por semana).

-   **Perfil de Placer/Social/Extraordinario**: En contraste, los motivos vinculados al ocio, a las reuniones sociales o eventos extraordinarios presentan una concentración mayoritaria (87,2%) en el rango de baja frecuencia (0-2 veces por semana).

#### 2. Relacionar la frecuencia con la que la muestra compra comida preparada de supermercado y el motivo principal

Analizaremos si existe una relación entre el motivo principal de comer fuera y la frecuencia con la que el usuario compra comida preparada en supermercados.

```{r}
# tabla de contingencia inicial
proc_freq(datos, 'f_Motivo', 'f_Frecuencia.Comida.Preparada',
 include.row_percent = TRUE,
 include.column_percent = FALSE,
 include.table_percent = FALSE) %>%
 compose(i=2, j=1, value = as_paragraph('Motivo'), part = 'header') %>%
 compose(i=1, j=3, value = as_paragraph('Frecuencia Comida Preparada'), part = 'header') %>%
 set_caption('Tabla 22. Tabla de contingencia entre el motivo y la frecuencia de compra de comida preparada.') %>%
 autofit()
```

Parece haber una dispersión considerable en los datos.
Para determinar si existe una asociación estadísticamente significativa, aplicamos el test de Chi-cuadrado.

```{r}
# test del chi cuadrado inicial
res.chisq.prep <- chisq_test(
 x = datos$f_Motivo,
 y = datos$f_Frecuencia.Comida.Preparada)

# resultado de la evaluación
res.chisq.prep %>%
 flextable() %>%
 set_caption('Resultados del test del chi cuadrado (Comida Preparada') %>%
 colformat_num(
   j = c("statistic", "p"),
   big.mark = ".",
   decimal.mark = ","
 ) %>%
 autofit()


# sacamos los estadísticos descriptivos del test
chisq_descriptives(res.chisq.prep) %>%
 rename(
   Motivo = 'x',
   Frecuencia_Prep = 'y') %>%
 flextable() %>%
 set_caption('Estadísticos descriptivos del test (Valores esperados y residuos).') %>%
 colformat_num(
   j = c("prop", "row.prop", "col.prop", "expected", "resid", "std.resid"),
   big.mark = ".",
   decimal.mark = ","
 ) %>%
 autofit()
```

dada la fragmentación de las respuestas en las frecuencias altas, observamos múltiples celdas con valores esperados ("expected") menores a 5.
Esto invalida el resultado del test.

Agruparemos las frecuencias en dos categorías lógicas: "Baja frecuencia" (que incluye Nunca/Rara y Ocasional) y "Alta Frecuencia" (que agrupa a quienes consumen al menos 1 vez por semana)

```{r}
datos$f_Frecuencia.Prep.Agrupada <- datos$f_Frecuencia.Comida.Preparada

levels(datos$f_Frecuencia.Prep.Agrupada) <- list(
  'Baja frecuencia' = c('Nunca/Rara', 'Ocasional'),
  'Alta frecuencia (1+ veces/sem)'  = c('1-2/sem', '3-4/sem', '5+/sem')
)

proc_freq(datos, 'f_Motivo', 'f_Frecuencia.Prep.Agrupada',
  include.row_percent = TRUE,
  include.column_percent = FALSE,
  include.table_percent = FALSE) %>%
  compose(i=2, j=1, value = as_paragraph('Motivo'), part = 'header') %>%
  compose(i=1, j=3, value = as_paragraph('Frecuencia Supermercado (Agrupada)'), part = 'header') %>%
  set_caption('Tabla de contingencia: Motivo vs Frecuencia Comida Preparada (Agrupada)') %>%
  autofit()

res.chisq.prep.agrup <- chisq_test(
 x = datos$f_Motivo,
 y = datos$f_Frecuencia.Prep.Agrupada)

res.chisq.prep.agrup %>%
  flextable() %>%
  set_caption('Resultados finales del test Chi-cuadrado (Agrupado)') %>%
  colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
  autofit()

# Estadísticos descriptivos finales
chisq_descriptives(res.chisq.prep.agrup) %>%
 rename(Motivo = 'x', Frecuencia_Agrupada = 'y') %>%
 flextable() %>%
 set_caption('Estadísticos del test Chi-cuadrado (Agrupado) con residuos estandarizados.') %>%
 colformat_num(
   j = c("prop", "row.prop", "col.prop", "expected", "resid", "std.resid"),
   big.mark = ".", decimal.mark = ","
 ) %>%
 autofit()
```

Sigue habiendo problemas de validación del test.
Hay valores expected \< 5.\
Vamos a simplificar la variable "Motivo" en dos grandes perfiles lógicos de consumidor:

-   **Conveniencia (Perfil Funcional):** Comen fuera por necesidad (trabajo, estudios, falta de tiempo).

-   **Ocio y Otros (Perfil Hedónico):** Agrupamos "Social", "Placer" y "Extraordinario", ya que todos comparten que la ingesta es por disfrute o circunstancias voluntarias, no por obligación.

    ```{r}

    # 1. Agrupación de la Frecuencia (Baja vs Alta)
    datos$f_Frecuencia.Prep.Agrupada <- datos$f_Frecuencia.Comida.Preparada
    levels(datos$f_Frecuencia.Prep.Agrupada) <- list(
      'Baja Frecuencia' = c('Nunca/Rara', 'Ocasional'),
      'Alta Frecuencia'  = c('1-2/sem', '3-4/sem', '5+/sem')
    )

    # 2. Agrupación de los Motivos (Conveniencia vs Ocio/Otros)
    datos$f_Motivo_Binario <- datos$f_Motivo
    levels(datos$f_Motivo_Binario) <- list(
      'Conveniencia' = 'Conveniencia',
      'Ocio/Social/Otros' = c('Social', 'Placer', 'Extraordinario')
    )

    # 3. Tabla de Contingencia 2x2
    proc_freq(datos, 'f_Motivo_Binario', 'f_Frecuencia.Prep.Agrupada',
      include.row_percent = TRUE,
      include.column_percent = FALSE,
      include.table_percent = FALSE) %>%
      compose(i=2, j=1, value = as_paragraph('Tipo de Motivo'), part = 'header') %>%
      compose(i=1, j=3, value = as_paragraph('Frecuencia Compra Prep.'), part = 'header') %>%
      set_caption('Tabla 23. Tabla de contingencia: Motivos Funcionales vs Ocio y Frecuencia de Compra.') %>%
      autofit()

    # 4. Test Chi-Cuadrado
    res.chisq.final <- chisq_test(
     x = datos$f_Motivo_Binario,
     y = datos$f_Frecuencia.Prep.Agrupada)

    # Mostrar resultados
    res.chisq.final %>%
      flextable() %>%
      set_caption('Resultados del test Chi-cuadrado (Modelo 2x2).') %>%
      colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
      autofit()

    # 5. Estadísticos descriptivos (Validación final)
    chisq_descriptives(res.chisq.final) %>%
     rename(Motivo_Agrupado = 'x', Frecuencia = 'y') %>%
     flextable() %>%
     set_caption('Estadísticos del test (Valores esperados y residuos).') %>%
     colformat_num(
       j = c("expected", "std.resid"),
       big.mark = ".", decimal.mark = ","
     ) %>%
     autofit()

    ```

Se cumple la condición de validación del test, puesto que todos los valores expected \> 5.

El test proporciona un p-valor \> 0,05, por lo que no podemos rechazar la hipótesis nula.
Esto indica que no existe una dependencia significativa entre el motivo por el cual el usuario come fuera de casa y su hábito de comprar comida preparada de supermercado.\

#### 3. Contrastar la creencia de que se recurre a la comida rápida por falta de tiempo.

```{r}
# Tabla de contingencia inicial
proc_freq(datos, 'f_Motivo', 'f_Tipo.Comida.Rapida',
 include.row_percent = TRUE,
 include.column_percent = FALSE,
 include.table_percent = FALSE) %>%
 compose(i=2, j=1, value = as_paragraph('Motivo'), part = 'header') %>%
 compose(i=1, j=3, value = as_paragraph('Consume Comida Rápida'), part = 'header') %>%
 set_caption('Tabla 24. Tabla de contingencia entre el motivo y el consumo de comida rápida.') %>%
 autofit()

# Realizamos el test del chi cuadrado inicial
res.chisq.comidarapida <- chisq_test(
 x = datos$f_Motivo,
 y = datos$f_Tipo.Comida.Rapida)

# Mostramos el resultado
res.chisq.comidarapida %>%
 flextable() %>%
 set_caption('Resultados del test del chi cuadrado (Comida Rápida - Sin agrupar).') %>%
 colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
 autofit()

# Verificamos los valores esperados
chisq_descriptives(res.chisq.comidarapida) %>%
 rename(Motivo = 'x', Comida_Rapida = 'y') %>%
 flextable() %>%
 set_caption('Estadísticos descriptivos del test (Valores esperados).') %>%
 colformat_num(
   j = c("expected", "std.resid"),
   big.mark = ".", decimal.mark = ","
 ) %>%
 autofit() 
```

De nuevo, encontramos valores expected \< 5.
Para solucionarlo utilizaremos la agrupación de motivos que definimos anteriormente (perfil funcional y perfil hedónico)

```{r}

datos$f_Motivo_Binario <- datos$f_Motivo
levels(datos$f_Motivo_Binario) <- list(
  'Conveniencia (Falta tiempo)' = 'Conveniencia',
  'Ocio/Social/Otros' = c('Social', 'Placer', 'Extraordinario')
)

proc_freq(datos, 'f_Motivo_Binario', 'f_Tipo.Comida.Rapida',
  include.row_percent = TRUE,
  include.column_percent = FALSE,
  include.table_percent = FALSE) %>%
  compose(i=2, j=1, value = as_paragraph('Tipo de Motivo'), part = 'header') %>%
  compose(i=1, j=3, value = as_paragraph('Consume Comida Rápida'), part = 'header') %>%
  set_caption('Tabla 25. Tabla de contingencia: Motivos Funcionales vs Ocio y Comida Rápida.') %>%
  autofit()

res.chisq.fastfood.final <- chisq_test(
 x = datos$f_Motivo_Binario,
 y = datos$f_Tipo.Comida.Rapida)

# Mostrar resultados
res.chisq.fastfood.final %>%
  flextable() %>%
  set_caption('Resultados del test Chi-cuadrado (Modelo 2x2).') %>%
  colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
  autofit()

# 4. Análisis de Residuos 
chisq_descriptives(res.chisq.fastfood.final) %>%
 rename(Motivo_Agrupado = 'x', Comida_Rapida = 'y') %>%
 flextable() %>%
 set_caption('Estadísticos finales y residuos estandarizados.') %>%
 colformat_num(
   j = c("prop", "row.prop", "col.prop", "expected", "resid", "std.resid"),
   big.mark = ".", decimal.mark = ","
 ) %>%
 autofit()
```

Todos los valores expected son mayores de 5, por lo que el test es válido.

El test proporciona un p-valor \> 0,05, por lo que no podemos rechazar la hipótesis nula.
Esto indica que, en nuestra muestra, no existe una dependencia significativa entre el motivo por el cual el usuario come fuera de casa y su consumo de comida rápida.
Observando la tabla de contingencia, se aprecia que ambos grupos cuentan con proporciones similares.

#### 4. Establecer la relación entre los lugares a los que se acude cuando se come fuera de casa (bar o restaurante, trabajo o centro educativo, vía pública) y el tipo de comida elegido (rápida, platos preparados, de elaboración propia o comida preparada en un restaurante).

El objetivo es determinar si el lugar elegido para comer fuera de casa condiciona el tipo de comida consumida.
Dado que la variable sobre el tipo de comida permite respuesta múltiple, se analizará la asociación de forma individualizada para las categorías principales.

##### 4.1. Asociación con Comida de Rápida

Primero, verificamos la relación entre el lugar habitual y el consumo de comida preparada en restaurantes de comida rápida.

```{r}
# Tabla de contingencia: Lugar vs Comida Rápida
proc_freq(datos, 'f_Lugar.Habitual', 'f_Tipo.Comida.Rapida',
 include.row_percent = TRUE,
 include.column_percent = FALSE,
 include.table_percent = FALSE) %>%
 compose(i=2, j=1, value = as_paragraph('Lugar Habitual'), part = 'header') %>%
 compose(i=1, j=3, value = as_paragraph('Consume Comida Rápida'), part = 'header') %>%
 set_caption('Tabla 26. Contingencia: Lugar Habitual vs Comida Rápida.') %>%
 autofit()

# Test Chi-cuadrado
res.chisq.rapida <- chisq_test(
 x = datos$f_Lugar.Habitual,
 y = datos$f_Tipo.Comida.Rapida)

res.chisq.rapida %>%
 flextable() %>%
 set_caption('Resultados del test Chi-cuadrado (Comida Rápida).') %>%
 colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
 autofit()

# Verificación de los valores esperados
chisq_descriptives(res.chisq.rapida) %>%
 rename(Lugar = 'x', Comida_Rapida = 'y') %>%
 flextable() %>%
 set_caption('Estadísticos y valores esperados: Lugar vs Comida Rápida.') %>%
 colformat_num(
   j = c("prop", "row.prop", "col.prop", "expected", "resid", "std.resid"),
   big.mark = ".", decimal.mark = ","
 ) %>%
 autofit()
```

Encontramos valores expected \< 5.
Por tanto, el test no es válido.
Para solucionarlo, agruparemos los lugares en 2 categorías lógicas, y los próximos análisis.

-   Hostelería: Bar o restaurante

-   Otros espacios: Lugares donde no sirven la comida y requieren un tupper (Vía pública, oficina/centro educativo)

```{r}
# --- CREACIÓN DE LA VARIABLE AGRUPADA ---
datos$f_Lugar_Agrupado <- datos$f_Lugar.Habitual
levels(datos$f_Lugar_Agrupado) <- list(
  'Restauración (Bar/Rte)' = 'Restaurante/Bar',
  'Otros (Oficina/Centro/Calle)' = c('Oficina/Centro', 'Vía Pública')
)

```

A continuación, realizamos los análisis de los 4 lugares con esta variable agrupada.\

\

```{r}
# Tabla de contingencia
proc_freq(datos, 'f_Lugar_Agrupado', 'f_Tipo.Comida.Rapida',
 include.row_percent = TRUE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
 compose(i=2, j=1, value = as_paragraph('Lugar (Agrupado)'), part = 'header') %>%
 compose(i=1, j=3, value = as_paragraph('Consume Comida Rápida'), part = 'header') %>%
 set_caption('Tabla 26. Contingencia: Lugar vs Comida Rápida.') %>%
 autofit()

# Test Chi-cuadrado
res.chisq.rapida <- chisq_test(x = datos$f_Lugar_Agrupado, y = datos$f_Tipo.Comida.Rapida)
res.chisq.rapida %>% flextable() %>%
 set_caption('Test Chi-cuadrado (Comida Rápida).') %>%
 colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>% autofit()

# Validación (Esperados)
chisq_descriptives(res.chisq.rapida) %>%
 rename(Lugar = 'x', Comida_Rapida = 'y') %>% flextable() %>%
 set_caption('Estadísticos y residuos (Comida Rápida).') %>%
 colformat_num(j = c("expected", "std.resid"), big.mark = ".", decimal.mark = ",") %>% autofit()
```

Todos los valores expected son mayores que 5, así que consideramos que el test es válido.

Únicamente un 14.3% de los encuestados que comen en la calle, la oficina o en su centro educativo come comida rápida, frente a un porcentaje ligeramente mayor, 35.7%, para los que comen en bares o restaurantes.

El test calcula un p-valor \> 0,05, por lo que no podemos rechazar la hipótesis nula.
Por tanto, no podemos determinar una dependencia significativa entre el motivo por el que se come fuera y el consumo de comida rápida.

##### 4.2. Asociación con Platos Preparados de Supermercado

Observamos si el consumo de platos de supermercado (listos para comer) destaca en alguno de los dos entornos.

```{r}
# Tabla de contingencia
proc_freq(datos, 'f_Lugar_Agrupado', 'f_Tipo.Comida.Super',
 include.row_percent = TRUE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
 compose(i=2, j=1, value = as_paragraph('Lugar (Agrupado)'), part = 'header') %>%
 compose(i=1, j=3, value = as_paragraph('Consume Platos Super'), part = 'header') %>%
 set_caption('Tabla 27. Contingencia: Lugar vs Platos de Supermercado.') %>%
 autofit()

# Test Chi-cuadrado
res.chisq.super <- chisq_test(x = datos$f_Lugar_Agrupado, y = datos$f_Tipo.Comida.Super)
res.chisq.super %>% flextable() %>%
 set_caption('Test Chi-cuadrado (Platos Supermercado).') %>%
 colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>% autofit()

# Validación
chisq_descriptives(res.chisq.super) %>%
 rename(Lugar = 'x', Comida_Super = 'y') %>% flextable() %>%
 set_caption('Estadísticos y residuos (Platos Supermercado).') %>%
 colformat_num(j = c("expected", "std.resid"), big.mark = ".", decimal.mark = ",") %>% autofit()
```

Consideramos el test como válido aunque haya un valor excepted ligaramente menor que 5.
Es difícil agrupar más las categorías sin perder información esencial.
El problema viene principalmente de una muestra de tamaño reducido.\

\
Solo un 11.9% de personas que suelen comer en bares o restaurantes suele comer comida preparada de supermercados cuando comen fuera, frente al 38,1% de las personas que suelen comer en la calle, la oficina o centro educativo.\
El test nos proporciona un p-valor \< 0,05, por lo que podemos rechazar la hipótesis nula y afirmar que existe una dependencia significativa entre el lugar donde se suele comer fuera de casa y el consumo de platos preparados de supermercado.
Los encuestados que suelen comer en restaurantes son los que menos consumen este tipo de platos.

##### 4.3. Asociación con Comida de Elaboración Propia (Tupper)

```{r}
# Tabla de contingencia
proc_freq(datos, 'f_Lugar_Agrupado', 'f_Tipo.Comida.Propia',
 include.row_percent = TRUE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
 compose(i=2, j=1, value = as_paragraph('Lugar (Agrupado)'), part = 'header') %>%
 compose(i=1, j=3, value = as_paragraph('Consume Comida Propia'), part = 'header') %>%
 set_caption('Tabla 28. Contingencia: Lugar vs Comida Propia.') %>%
 autofit()

# Test Chi-cuadrado
res.chisq.propia <- chisq_test(x = datos$f_Lugar_Agrupado, y = datos$f_Tipo.Comida.Propia)
res.chisq.propia %>% flextable() %>%
 set_caption('Test Chi-cuadrado (Comida Propia).') %>%
 colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>% autofit()

# Validación y Residuos
chisq_descriptives(res.chisq.propia) %>%
 rename(Lugar = 'x', Comida_Propia = 'y') %>% flextable() %>%
 set_caption('Estadísticos y residuos (Comida Propia).') %>%
 colformat_num(j = c("expected", "std.resid"), big.mark = ".", decimal.mark = ",") %>% autofit()
```

![](images/clipboard-1362719507.png)

\
Solo un 21.4% de personas que suelen comer en bares o restaurantes suele comer comida preparada en casa cuando comen fuera, frente al 47,6% de las personas que suelen comer en la calle, la oficina o centro educativo.\

\
Al realizar el test de Chi-cuadrado, obtenemos un p-valor ligeramente superior a 0,05 (p = 0,065), lo que técnicamente no permite rechazar la hipótesis nula de independencia con el criterio del 95% de confianza.

Sin embargo, es crucial observar la tabla de contingencia: el consumo de comida propia es del **47,6%** en los entornos de 'Otros' (Oficina/Centro/Vía Pública), frente a solo un 21,4% en 'Restauración'.
Esta diferencia sustancial de más de 26 puntos porcentuales sugiere una tendencia clara hacia la dependencia, que no ha alcanzado la significatividad estadística debido probablemente al tamaño limitado de la muestra.

##### 4.4. Asociación con Comida de Bar o Restaurante

Finalmente, verificamos la consistencia de las respuestas cruzando el lugar con el consumo de menú o platos de restaurante.

```{r}
# Tabla de contingencia
proc_freq(datos, 'f_Lugar_Agrupado', 'f_Tipo.Comida.Restaurante',
 include.row_percent = TRUE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
 compose(i=2, j=1, value = as_paragraph('Lugar (Agrupado)'), part = 'header') %>%
 compose(i=1, j=3, value = as_paragraph('Consume Comida Restaurante'), part = 'header') %>%
 set_caption('Tabla 29. Contingencia: Lugar vs Comida de Restaurante.') %>%
 autofit()

# Test Chi-cuadrado
res.chisq.rest <- chisq_test(x = datos$f_Lugar_Agrupado, y = datos$f_Tipo.Comida.Restaurante)
res.chisq.rest %>% flextable() %>%
 set_caption('Test Chi-cuadrado (Comida Restaurante).') %>%
 colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>% autofit()

# Validación
chisq_descriptives(res.chisq.rest) %>%
 rename(Lugar = 'x', Comida_Restaurante = 'y') %>% flextable() %>%
 set_caption('Estadísticos y residuos (Comida Restaurante).') %>%
 colformat_num(j = c("expected", "std.resid"), big.mark = ".", decimal.mark = ",") %>% autofit()
```

El test nos proporciona un p-valor \< 0,05.
Por lo tanto, podemos rechazar la hipótesis nula de independencia y afirmar que existe una dependencia estadísticamente significativa entre el lugar habitual donde se come fuera de casa y la elección de comida preparada en un bar o restaurante.

El análisis de la distribución (porcentajes por fila) confirma la dirección de esta dependencia:

-   Un 81,0% de los encuestados que come en un entorno de restauración elige consumir comida de restaurante.

-   En contraste, solo un 42,9% de los encuestados que come en otros espacios elige este tipo de comida.

##### 6. Relación entre la sensación de saciedad y la aceptación

Evaluamos si la percepción del producto como una opción "ligera" (que no llena mucho) o como un "plato principal" influye en la intención de uso.
Para ello, hemos creado una nueva variable (`f_Perfil_Saciedad`) que agrupa a los usuarios que indicaron que usarían la barra para una "cena ligera" o como un "complemento" frente al resto.

```{r}
# 1. Creación de la variable de Perfil de Saciedad
# Si el usuario marcó 'Sí' en Cena Ligera O en Complemento, lo clasificamos como "Ligero"
datos <- datos %>%
  dplyr::mutate(
    f_Perfil_Saciedad = dplyr::case_when(
      f_Uso.Cena == 'Sí' | f_Uso.Complem == 'Sí' ~ "Percibe como Ligero/Complemento",
      TRUE ~ "Percibe como Plato Principal"
    )
  )

# Convertimos a factor para el análisis
datos$f_Perfil_Saciedad <- factor(datos$f_Perfil_Saciedad)

# 2. Tabla de contingencia
proc_freq(datos, 'f_Perfil_Saciedad', 'f_Intencion.Uso',
  include.row_percent = TRUE,
  include.column_percent = FALSE,
  include.table_percent = FALSE) %>%
  compose(i=2, j=1, value = as_paragraph('Percepción de Saciedad'), part = 'header') %>%
  compose(i=1, j=3, value = as_paragraph('Intención de Uso'), part = 'header') %>%
  set_caption('Tabla 28. Tabla de contingencia: Percepción de Saciedad vs Intención de Uso.') %>%
  autofit()

# 3. Test Chi-cuadrado
res.chisq.saciedad <- chisq_test(
 x = datos$f_Perfil_Saciedad,
 y = datos$f_Intencion.Uso)

# Mostrar resultados del test
res.chisq.saciedad %>%
  flextable() %>%
  set_caption('Resultados del test Chi-cuadrado (Saciedad).') %>%
  colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
  autofit()

# 4. Estadísticos descriptivos y residuos
chisq_descriptives(res.chisq.saciedad) %>%
 rename(Perfil_Saciedad = 'x', Intencion = 'y') %>%
 flextable() %>%
 set_caption('Estadísticos del test (Valores esperados y residuos).') %>%
 colformat_num(
   j = c("prop", "row.prop", "col.prop", "expected", "resid", "std.resid"),
   big.mark = ".", decimal.mark = ","
 ) %>%
 autofit()

```

Todos los valores expected \> 5, consideramos el test como válido.
El valor del p-valor \< 0,05 permite rechazar la hipótesis nula.
Existe una relación de dependencia estadísticamente significativa entre cómo percibe el usuario la capacidad de saciar del producto y su intención de usarlo.

Los usuarios que conciben la ensalada como una cena ligera o un acompañamiento muestran una aceptación abrumadora del 87,9%.
Por el contrario, aquellos que la utilizarían como plato único principal (comida en el momento o para llevar al trabajo) muestran una aceptación considerablemente menor, del 56,7%.

Este hallazgo es crucial para el posicionamiento del producto.
La barra de ensaladas tiene un éxito casi garantizado si se comercializa como una solución para cenas ligeras o como complemento saludable, mientras que genera más dudas entre quienes buscan una comida completa y contundente.
Esto sugiere que, para captar al segmento de "Plato Principal", quizás sería necesario reforzar la percepción de saciedad (por ejemplo, destacando proteínas o bases más pesadas como pasta/arroz en la comunicación).

##### 7. Relacionar la relevancia de comer saludable con la aceptación de la barra de ensaladas

Primero, observamos la distribución inicial con los 5 niveles de la escala Likert.

```{r}
# Tabla de contingencia inicial (Escala completa 1-5)
proc_freq(datos, 'f_Importancia.Saludable', 'f_Intencion.Uso',
 include.row_percent = TRUE,
 include.column_percent = FALSE,
 include.table_percent = FALSE) %>%
 compose(i=2, j=1, value = as_paragraph('Importancia Saludable (1-5)'), part = 'header') %>%
 compose(i=1, j=3, value = as_paragraph('Intención de Uso'), part = 'header') %>%
 set_caption('Tabla 26. Tabla de contingencia: Importancia Saludable vs Intención de Uso.') %>%
 autofit()

# Test Chi-cuadrado inicial
res.chisq.salud <- chisq_test(
 x = datos$f_Importancia.Saludable,
 y = datos$f_Intencion.Uso)

# Mostrar resultados del test
res.chisq.salud %>%
 flextable() %>%
 set_caption('Resultados del test Chi-cuadrado (Sin agrupar).') %>%
 colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
 autofit()

# Verificación de condiciones (Valores esperados)
chisq_descriptives(res.chisq.salud) %>%
 rename(Importancia = 'x', Intencion = 'y') %>%
 flextable() %>%
 set_caption('Estadísticos del test (Valores esperados y residuos).') %>%
 colformat_num(
   j = c("expected", "std.resid"),
   big.mark = ".", decimal.mark = ","
 ) %>%
 autofit()
```

Debido a la presencia de valores expected \< 5, agruparemos la importancia en 2 niveles.

-   Baja/Media: 1, 2 y 3

-   Alta: 4 y 5

    \

```{r}
# 1. Creación de la variable agrupada
datos$f_Imp_Salud_Agrupada <- datos$f_Importancia.Saludable
levels(datos$f_Imp_Salud_Agrupada) <- list(
  'Baja/Media (1-3)' = c('1', '2', '3'),
  'Alta (4-5)'       = c('4', '5')
)

# 2. Tabla de contingencia agrupada
proc_freq(datos, 'f_Imp_Salud_Agrupada', 'f_Intencion.Uso',
  include.row_percent = TRUE,
  include.column_percent = FALSE,
  include.table_percent = FALSE) %>%
  compose(i=2, j=1, value = as_paragraph('Importancia Saludable (Agrupada)'), part = 'header') %>%
  compose(i=1, j=3, value = as_paragraph('Intención de Uso'), part = 'header') %>%
  set_caption('Tabla 27. Tabla de contingencia: Importancia (Agrupada) vs Intención de Uso.') %>%
  autofit()

# 3. Test Chi-cuadrado final
res.chisq.salud.final <- chisq_test(
 x = datos$f_Imp_Salud_Agrupada,
 y = datos$f_Intencion.Uso)

# Mostrar resultados
res.chisq.salud.final %>%
  flextable() %>%
  set_caption('Resultados del test Chi-cuadrado (Variable Agrupada).') %>%
  colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
  autofit()

# 4. Estadísticos descriptivos finales
chisq_descriptives(res.chisq.salud.final) %>%
 rename(Importancia_Agrupada = 'x', Intencion = 'y') %>%
 flextable() %>%
 set_caption('Estadísticos finales del test y residuos estandarizados.') %>%
 colformat_num(
   j = c("prop", "row.prop", "col.prop", "expected", "resid", "std.resid"),
   big.mark = ".", decimal.mark = ","
 ) %>%
 autofit()
```

Consideramos que el test es válido ya que todos los valores expected \> 5.

El p-valor es mayor que 0,05, por lo que no podemos rechazar la hipótesis nula.
No existe una dependencia estadísticamente significativa entre la importancia que el consumidor asigna a comer saludable y su intención de usar la barra de ensaladas.

-   El grupo que da poca o media importancia a la salud muestra una aceptación del 74,2%.

-   El grupo que da mucha importancia a la salud muestra una aceptación del 71,9%.

Ambos porcentajes son muy similares.
Esto sugiere que la barra de ensaladas es un producto transversal: atrae tanto a los consumidores concienciados con la salud como a aquellos que no lo priorizan tanto, probablemente debido a otros factores como la conveniencia.

##### 8. Comparar el interés potencial entre quienes comen fuera y quienes no

Analizamos si el hábito de comer fuera de casa influye en la intención de utilizar la barra de ensaladas.
Para este análisis, hemos agrupado a los encuestados en dos perfiles:

-   **Baja Frecuencia:** Quienes nunca comen fuera o lo hacen solo ocasionalmente.

-   **Alta Frecuencia:** Quienes comen fuera de manera recurrente (al menos 1 vez por semana).

```{r}
datos$f_Comer_Fuera_Binaria <- datos$f_Frecuencia
levels(datos$f_Comer_Fuera_Binaria) <- list(
  'Baja Frecuencia (Nunca/Ocasional)' = c('Nunca/Rara', 'Ocasional'),
  'Alta Frecuencia (1+ veces/sem)'    = c('1-2/sem', '3-4/sem', '5+/sem')
)

# Tabla de contingencia
proc_freq(datos, 'f_Comer_Fuera_Binaria', 'f_Intencion.Uso',
  include.row_percent = TRUE,
  include.column_percent = FALSE,
  include.table_percent = FALSE) %>%
  compose(i=2, j=1, value = as_paragraph('Hábito de Comer Fuera'), part = 'header') %>%
  compose(i=1, j=3, value = as_paragraph('Intención de Uso'), part = 'header') %>%
  set_caption('Tabla 29. Tabla de contingencia: Hábito de Comer Fuera vs Intención de Uso.') %>%
  autofit()

# Test Chi-cuadrado
res.chisq.habito <- chisq_test(
 x = datos$f_Comer_Fuera_Binaria,
 y = datos$f_Intencion.Uso)

# Mostrar resultados
res.chisq.habito %>%
  flextable() %>%
  set_caption('Resultados del test Chi-cuadrado (Hábito).') %>%
  colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
  autofit()

# Estadísticos descriptivos
chisq_descriptives(res.chisq.habito) %>%
 rename(Habito = 'x', Intencion = 'y') %>%
 flextable() %>%
  set_caption('Estadísticos del test (Valores esperados y residuos).') %>%
 colformat_num(
   j = c("prop", "row.prop", "col.prop", "expected", "resid", "std.resid"),
   big.mark = ".", decimal.mark = ","
 ) %>%
 autofit()
```

El test es válido ya que todos los valores expected \> 5.
Como el p-valor \> 0,05, no podemos rechazar la hipótesis nula y concluimos que no hay ninguna diferencia significativa en la aceptación del producto entre los encuestados que comen fuera frecuentemente y los que no.

La barra de ensaladas tiene un atractivo universal.
Interesa tanto a quienes comen fuera por rutina semanal como a quienes lo hacen solo de forma esporádica u ocasional.

##### 9. Analizar cómo las malas experiencias anteriores con platos preparados o autoservicio influyen en el interés potencial por el producto.

Agrupamos la variable cualitativa de malas experiencias en dos categorías: "Mala experiencia" y "No mala experiencia".

```{r}

datos$f_Exp_Negativa_Binaria <- factor(
  ifelse(datos$Categoria_Mala_Exp == "No Mala Experiencia", 
         "No ha tenido mala experiencia", 
         "Sí ha tenido mala experiencia")
)

# Tabla de contingencia
proc_freq(datos, 'f_Exp_Negativa_Binaria', 'f_Intencion.Uso',
  include.row_percent = TRUE,
  include.column_percent = FALSE,
  include.table_percent = FALSE) %>%
  compose(i=1, j=1, value = as_paragraph('Antecedentes'), part = 'header') %>%
  compose(i=1, j=3, value = as_paragraph('Intención de Uso'), part = 'header') %>%
  set_caption('Tabla 30. Tabla de contingencia: Malas Experiencias Previas (Binaria) vs Intención de Uso.') %>%
  autofit()

# Test Chi-cuadrado
res.chisq.negativa <- chisq_test(
 x = datos$f_Exp_Negativa_Binaria,
 y = datos$f_Intencion.Uso)

# Mostrar resultados
res.chisq.negativa %>%
  flextable() %>%
  set_caption('Resultados del test Chi-cuadrado (Malas Experiencias).') %>%
  colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
  autofit()

# Estadísticos descriptivos
chisq_descriptives(res.chisq.negativa) %>%
 rename(Tiene_Mala_Exp = 'x', Intencion = 'y') %>%
 flextable() %>%
 set_caption('Estadísticos del test (Valores esperados y residuos).') %>%
 colformat_num(
   j = c("prop", "row.prop", "col.prop", "expected", "resid", "std.resid"),
   big.mark = ".", decimal.mark = ","
 ) %>%
 autofit()
```

Todos los valores expected son mayores que 5, por lo que el test es válido.

El p-valor es mayor que 0,05, por lo que no podemos rechazar la hipótesis nula.
Por tanto, concluimos que no existe una dependencia significativa entre la aceptación del producto y si las experiencias previas con productos similares han sido positivas o negativas,.

##### 10. Vincular el formato de dispensación preferido con las características consideradas más prioritarias (sostenibilidad, precio, higiene, rapidez del servicio, sabor, variedad y origen de los ingredientes)

Analizamos si el formato de dispensación preferido (`f_Preferencia.Dispensacion`) influye en la importancia que se le da a distintos atributos (Precio, Higiene, Sabor, etc.).

Seleccionamos las columnas de interés y convertimos las escalas Likert (que R lee como factores) a números para poder operar con ellas.

```{r}
# Bloque 1: Selección y transformación
# Seleccionamos el formato preferido y las 7 variables de importancia
datos_analisis <- datos %>%
  dplyr::select(f_Preferencia.Dispensacion, 
                f_Imp.Sostenibilidad, f_Imp.Origen.Local, f_Imp.Variedad,
                f_Imp.Sabor, f_Imp.Precio, f_Imp.Higiene, f_Imp.Rapidez) %>%
  # Transformamos las escalas Likert a numérico (1-5)
  dplyr::mutate(across(starts_with("f_Imp"), ~as.numeric(as.character(.)))) %>%
  drop_na()

# Lista de las variables que vamos a analizar una a una
variables_a_testear <- names(datos_analisis)[grepl("f_Imp", names(datos_analisis))]
```

Comprobamos si los residuos de cada variable siguen una distribución normal.
Según la guía docente (apartado 7.2), usamos el test de **Anderson-Darling** (`ad.test`).

```{r}
# Función auxiliar para calcular Anderson-Darling de una variable
calcular_normalidad <- function(var_nombre, df) {
  # 1. Creamos el modelo lineal
  formula <- as.formula(paste(var_nombre, "~ f_Preferencia.Dispensacion"))
  modelo <- lm(formula, data = df)
  
  # 2. Extraemos residuos y aplicamos Anderson-Darling
  test <- nortest::ad.test(residuals(modelo))
  
  return(data.frame(Variable = gsub("f_Imp.", "", var_nombre),
                    P_Valor_Norm = test$p.value))
}

# Ejecutamos la función para todas las variables
tabla_normalidad <- do.call(rbind, lapply(variables_a_testear, calcular_normalidad, df = datos_analisis))

# Imprimimos la tabla
flextable::flextable(tabla_normalidad) %>%
  set_caption("Tabla 31. Test de Normalidad de Anderson-Darling (Residuos).") %>%
  colformat_double(j = "P_Valor_Norm", digits = 4, decimal.mark = ",") %>%
  # Marcamos en rojo si NO es normal (p < 0.05) para verlo rápido
  color(i = ~ P_Valor_Norm < 0.05, j = "P_Valor_Norm", color = "red") %>%
  autofit()
```

Dado que todos los p-valor son menores que 0,05, se rechaza la hipótesis nula y confirmamos que no hay normalidad en ninguna de las variables.
Esto indica que debemos usar la prueba de Kruskal-Wallis en lugar de ANOVA.

```{r}
# Calculamos Kruskal-Wallis para todas las variables
res_kruskal <- datos_analisis %>%
  tidyr::pivot_longer(cols = starts_with("f_Imp"), names_to = "Variable", values_to = "Valor") %>%
  group_by(Variable) %>%
  rstatix::kruskal_test(Valor ~ f_Preferencia.Dispensacion) %>%
  mutate(Variable = gsub("f_Imp.", "", Variable))

# Imprimimos la tabla final de decisión
res_kruskal %>%
  dplyr::select(Variable, n, statistic, df, p, method) %>%
  flextable::flextable() %>%
  set_caption("Tabla 33. Resultados del Test de Kruskal-Wallis (Dependencia Final).") %>%
  colformat_double(j = c("statistic", "p"), digits = 3, decimal.mark = ",") %>%
  # Si alguno sale significativo (p < 0.05), se pondrá en negrita
  bold(i = ~ p < 0.05, bold = TRUE) %>%
  autofit()
```

1.  Para todas las variables analizadas (Higiene, Origen Local, Precio, Rapidez, Sabor, Sostenibilidad y Variedad), se han obtenido p-valores muy superiores al nivel de significación de 0,05 (oscilando entre 0,112 y 0,959).
    Esto nos lleva a no rechazar la hipótesis nula en ninguno de los casos.
    No existe evidencia estadística de que la importancia asignada a estos atributos varíe en función del formato de dispensación preferido por el consumidor.

    Los resultados desmienten la creencia de que la preferencia por un formato (ej. vitrina cerrada vs. autoservicio) se deba a una mayor exigencia en atributos específicos como la higiene o la rapidez.
    Los consumidores valoran estos factores con la misma intensidad, independientemente de cómo prefieran que se les sirva el producto.

##### 11. Relación entre los ingredientes demandados y la edad

Nos centramos ahora en los productos estrella de la barra de ensaladas.
Primero identificamos cuáles son los ingredientes más seleccionados por los consumidores y, a continuación, analizamos si su demanda depende de la edad del consumidor.

```{r}
# 1. Identificación de los "Top 3" Ingredientes más demandados
# Buscamos todas las variables de ingredientes (Base, Proteína, Complementos)
vars_ingredientes <- names(datos)[grep("f_Base|f_Prot|f_Complem", names(datos))]

# Calculamos cuál es el porcentaje de "Sí" para cada uno
ranking_popularidad <- datos %>%
  dplyr::select(all_of(vars_ingredientes)) %>%
  # Convertimos "Sí" a 1 y "No" a 0 para sumar
  dplyr::mutate(across(everything(), ~ifelse(. == "Sí", 1, 0))) %>%
  # Sumamos los "Sí" de cada columna
  summarise(across(everything(), sum, na.rm = TRUE)) %>%
  tidyr::pivot_longer(cols = everything(), names_to = "Variable", values_to = "Total_Si") %>%
  # Ordenamos de mayor a menor demanda
  arrange(desc(Total_Si)) %>%
  slice(1:3) # Nos quedamos con los 3 primeros

# Guardamos los nombres de las variables Top
top_ingredientes <- ranking_popularidad$Variable
nombres_limpios <- gsub("f_Base.|f_Prot.|f_Complem.", "", top_ingredientes)

# Mostramos cuáles son para que quede constancia en el informe
print(paste("Los ingredientes más demandados a analizar son:", paste(nombres_limpios, collapse = ", ")))


# 2. Función para realizar el análisis detallado (Formato Estándar)
realizar_analisis_edad <- function(var_ingrediente, nombre_ingrediente) {
  
  # A. Tabla de Contingencia
  # Usamos print() para que se muestre dentro del bucle
  cat(paste("\n### Análisis para:", nombre_ingrediente, "\n"))
  
  t1 <- proc_freq(datos, var_ingrediente, 'f_Edad',
            include.row_percent = TRUE,
            include.column_percent = FALSE,
            include.table_percent = FALSE) %>%
    compose(i=2, j=1, value = as_paragraph(nombre_ingrediente), part = 'header') %>%
    compose(i=1, j=3, value = as_paragraph('Edad'), part = 'header') %>%
    set_caption(paste0("Tabla de contingencia: ", nombre_ingrediente, " vs Edad.")) %>%
    autofit()
  print(t1) # Forzamos la impresión
  
  # B. Test Chi-Cuadrado
  res_chisq <- rstatix::chisq_test(
    x = datos[[var_ingrediente]],
    y = datos$f_Edad
  )
  
  t2 <- res_chisq %>%
    flextable() %>%
    set_caption(paste0("Resultados del test Chi-cuadrado (", nombre_ingrediente, ").")) %>%
    colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
    autofit()
  print(t2)
  
  # C. Descriptivos (Validación de Expected)
  t3 <- rstatix::chisq_descriptives(res_chisq) %>%
    dplyr::rename(Ingrediente = 'x', Edad = 'y') %>%
    flextable() %>%
    set_caption(paste0("Estadísticos del test (Valores esperados): ", nombre_ingrediente, ".")) %>%
    colformat_num(j = c("expected", "std.resid"), big.mark = ".", decimal.mark = ",") %>%
    autofit()
  print(t3)
  
  cat("\n---\n") # Separador visual
}

# 3. Ejecutamos el análisis para los 3 ingredientes Top (Bucle)
# Nota: Al renderizar, esto generará las 3 tablas consecutivas para cada ingrediente
for (i in 1:3) {
  realizar_analisis_edad(top_ingredientes[i], nombres_limpios[i])
}
```

Encontramos valores expected menores que 5, por lo que el test no es válido.
Para corregirlo, vamos a agrupar a los encuestados en dos categorías: "Jóvenes" (hasta 24 años) y "No Jóvenes" (de 25 años en adelante).
Idealmente, debería haber más grupos de edades, pero el tamaño reducido de la muestra y el reducido número de encuestados mayores de 25 años nos obliga a hacer esta agrupación.

```{r}
# 1. Creación de la variable Edad Agrupada (Jovenes vs No Jovenes)
datos$f_Edad_Agrupada <- datos$f_Edad
levels(datos$f_Edad_Agrupada) <- list(
  'Jovenes'    = c('Menor de 18', '18 - 24'),
  'No Jovenes' = c('25 - 44', '45 - 64', '65+')
)

# 2. Identificación de los "Top 3" Ingredientes
vars_ingredientes <- names(datos)[grep("f_Base|f_Prot|f_Complem", names(datos))]

ranking_popularidad <- datos %>%
  dplyr::select(all_of(vars_ingredientes)) %>%
  dplyr::mutate(across(everything(), ~ifelse(. == "Sí", 1, 0))) %>%
  summarise(across(everything(), sum, na.rm = TRUE)) %>%
  tidyr::pivot_longer(cols = everything(), names_to = "Variable", values_to = "Total_Si") %>%
  arrange(desc(Total_Si)) %>%
  slice(1:3)

top_ingredientes <- ranking_popularidad$Variable
nombres_limpios <- gsub("f_Base.|f_Prot.|f_Complem.", "", top_ingredientes)

print(paste("Ingredientes analizados:", paste(nombres_limpios, collapse = ", ")))

# 3. Bucle de Análisis con la variable AGRUPADA
for (i in 1:3) {
  var_ingrediente <- top_ingredientes[i]
  nombre_ingrediente <- nombres_limpios[i]
  
  cat(paste("\n### Análisis para:", nombre_ingrediente, "\n"))
  
  # A. Tabla de Contingencia
  t1 <- proc_freq(datos, var_ingrediente, 'f_Edad_Agrupada',
            include.row_percent = TRUE,
            include.column_percent = FALSE,
            include.table_percent = FALSE) %>%
    compose(i=2, j=1, value = as_paragraph(nombre_ingrediente), part = 'header') %>%
    compose(i=1, j=3, value = as_paragraph('Grupo de Edad'), part = 'header') %>%
    set_caption(paste0("Tabla 34.", i, " Contingencia: ", nombre_ingrediente, " vs Edad.")) %>%
    autofit()
  print(t1)
  
  # B. Test Chi-Cuadrado
  res_chisq <- rstatix::chisq_test(x = datos[[var_ingrediente]], y = datos$f_Edad_Agrupada)
  
  t2 <- res_chisq %>%
    flextable() %>%
    set_caption(paste0("Resultado Chi-cuadrado (", nombre_ingrediente, ").")) %>%
    colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
    autofit()
  print(t2)
  
  # C. Validación (Expected)
  t3 <- rstatix::chisq_descriptives(res_chisq) %>%
    dplyr::rename(Ingrediente = 'x', Grupo_Edad = 'y') %>%
    flextable() %>%
    set_caption("Validación de esperados.") %>%
    colformat_num(j = c("expected", "std.resid"), big.mark = ".", decimal.mark = ",") %>%
    autofit()
  print(t3)
  
  cat("\n---\n")
}
```

Todos los tests son válidos, ya que todos los valores expected son mayores que 5.\
Todos los p-valores son mayores que 0,05, por tanto concluimos en que los ingredientes preferidos por los encuestados no depende de si son menores o mayores de 25 años.
Siempre son el pollo, la mezcla verde y los frutos secos.

##### 12. Relación entre los ingredientes más demandados y el género

Analizamos si existen diferencias significativas en la preferencia de los ingredientes principales según el género del consumidor.
Para garantizar la robustez del test estadístico, centramos el análisis en los dos grupos mayoritarios: **Hombres y Mujeres**.

```{r}
# 1. Preparación: Filtrado de Género (Solo Hombre/Mujer para robustez)
datos_genero <- datos %>%
  dplyr::filter(f_Genero %in% c("Hombre", "Mujer")) %>%
  droplevels()

# 2. Identificación de los "Top 3" Ingredientes (sobre la muestra filtrada)
vars_ingredientes <- names(datos_genero)[grep("f_Base|f_Prot|f_Complem", names(datos_genero))]

ranking_popularidad <- datos_genero %>%
  dplyr::select(all_of(vars_ingredientes)) %>%
  dplyr::mutate(across(everything(), ~ifelse(. == "Sí", 1, 0))) %>%
  summarise(across(everything(), sum, na.rm = TRUE)) %>%
  tidyr::pivot_longer(cols = everything(), names_to = "Variable", values_to = "Total_Si") %>%
  arrange(desc(Total_Si)) %>%
  slice(1:3)

top_ingredientes <- ranking_popularidad$Variable
nombres_limpios <- gsub("f_Base.|f_Prot.|f_Complem.", "", top_ingredientes)

print(paste("Ingredientes analizados por género:", paste(nombres_limpios, collapse = ", ")))

# 3. Bucle de Análisis
for (i in 1:3) {
  var_ingrediente <- top_ingredientes[i]
  nombre_ingrediente <- nombres_limpios[i]
  
  cat(paste("\n### Análisis de Género para:", nombre_ingrediente, "\n"))
  
  # A. Tabla de Contingencia
  t1 <- proc_freq(datos_genero, var_ingrediente, 'f_Genero',
            include.row_percent = TRUE,
            include.column_percent = FALSE,
            include.table_percent = FALSE) %>%
    compose(i=2, j=1, value = as_paragraph(nombre_ingrediente), part = 'header') %>%
    compose(i=1, j=3, value = as_paragraph('Género'), part = 'header') %>%
    set_caption(paste0("Tabla 35.", i, " Contingencia: ", nombre_ingrediente, " vs Género.")) %>%
    autofit()
  print(t1)
  
  # B. Test Chi-Cuadrado
  res_chisq <- rstatix::chisq_test(x = datos_genero[[var_ingrediente]], y = datos_genero$f_Genero)
  
  t2 <- res_chisq %>%
    flextable() %>%
    set_caption(paste0("Resultado Chi-cuadrado (", nombre_ingrediente, ").")) %>%
    colformat_num(j = c("statistic", "p"), big.mark = ".", decimal.mark = ",") %>%
    autofit()
  print(t2)
  
  # C. Validación (Expected)
  t3 <- rstatix::chisq_descriptives(res_chisq) %>%
    dplyr::rename(Ingrediente = 'x', Genero = 'y') %>%
    flextable() %>%
    set_caption("Validación de esperados.") %>%
    colformat_num(j = c("expected", "std.resid"), big.mark = ".", decimal.mark = ",") %>%
    autofit()
  print(t3)
  
  cat("\n---\n")
}
```
Todos los tests son válidos, ya que todos los valores expected son mayores que 5.\
Todos los p-valores son mayores que 0,05, por tanto concluimos en que los ingredientes preferidos por los encuestados no dependen de su género.

