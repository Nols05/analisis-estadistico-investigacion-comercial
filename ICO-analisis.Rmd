---
title: "Análisis de Mercado: Barra de Ensaladas"
subtitle: "Estudio sobre preferencias, hábitos de consumo y disposición de pago"
author: "Departamento de Análisis de Datos"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: flatly        # Temas recomendados: flatly, cerulean, journal, cosmo
    highlight: tango
    toc: true            # Tabla de contenidos
    toc_float:           # Tabla de contenidos flotante a la izquierda
      collapsed: false
      smooth_scroll: true
    number_sections: true
---

```{r setup, include=FALSE}
# Configuración global
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 10)
```

# 1. Preparación del Entorno


```{r librerias}
# Carga de librerías y configuraciones
if (!require("pacman")) install.packages("pacman")

pacman::p_load(
  readxl, splitstackshape, descr, rstatix, 
  tibble, dplyr, tidyr, ggplot2, 
  xtable, likert, ggpubr, flextable, 
  nortest, DT, RColorBrewer
)

options(digits = 3)

theme_set(theme_minimal() + 
            theme(plot.title = element_text(face = "bold", hjust = 0.5),
                  legend.position = "bottom"))
```

---

# 2. Ingesta y Limpieza de Datos {.tabset}

En esta sección procesamos el archivo crudo `respuestasEncuesta.xlsx`, renombrando las columnas para facilitar su manipulación y convirtiendo las variables categóricas.

## Carga y Renombrado

```{r carga_datos}
# Carga de datos y renombramiento de columnas

datos <- read_excel('respuestasEncuesta.xlsx')

nuevos_nombres <- c(
  'Marca.Temporal',              # Marca temporal
  'Motivo',                      # ¿Cuál es el principal motivo por el que suele comer fuera de casa?
  'Frecuencia',                  # ¿Con qué frecuencia suele comer fuera de casa?
  'Lugar.Habitual',              # Cuando come fuera ¿dónde suele comer?
  'Tipo.Comida',                 # Cuando come fuera, ¿qué tipo de comida suele elegir?
  'Frecuencia.Comida.Preparada', # ¿Con qué frecuencia compra comida preparada en un supermercado?
  'Supermercado.Habitual',       # ¿En qué supermercados suele comprar comida?
  'Importancia.Saludable',       # ¿Qué importancia tiene para usted comer de forma saludable cuando está fuera de casa?
  'Experiencia.Barra.Ensaladas', # ¿Ha probado alguna vez una barra de ensaladas?
  'Mala.Experiencia.Descripcion',# ¿Puede describir alguna mala experiencia que haya tenido con comida preparada o autoservicio...?
  'Situaciones.Uso',             # ¿En qué situaciones utilizaría la barra de ensaladas?
  'Formato.Preferido',           # ¿Qué formato preferiría?
  'Imp.Sostenibilidad',          # Valore importancia: [Sostenibilidad de los envases]
  'Imp.Origen.Local',            # Valore importancia: [Origen local de los productos]
  'Imp.Variedad',                # Valore importancia: [Variedad de ingredientes]
  'Imp.Sabor',                   # Valore importancia: [Sabor]
  'Imp.Precio',                  # Valore importancia: [Precio]
  'Imp.Higiene',                 # Valore importancia: [Higiene]
  'Imp.Rapidez',                 # Valore importancia: [Rapidez del servicio]
  'Preferencia.Base',            # ¿Qué tipo de base prefiere para sus ensaladas? (Hasta 2 opciones)
  'Preferencia.Proteina',        # De las siguientes proteínas ¿cuáles prefiere? (Hasta 2 opciones)
  'Preferencia.Complementos',    # De los siguientes complementos ¿cuáles prefiere? (Hasta 2 opciones)
  'Disposicion.Pago',            # ¿Cuánto está dispuesto/a a pagar por una ensalada completa de tamaño mediano (500g)?
  'Aptitud.Social',              # ¿Qué tan apropiadas considera las ensaladas para comidas en contextos sociales?
  'Preferencia.Dispensacion',    # ¿Qué formato de dispensación preferiría? (Comodidad, rapidez e higiene)
  'Intencion.Uso',               # Si su supermercado habitual ofreciera nuestra barra de ensaladas, ¿la usaría?
  'Edad',                        # ¿En qué rango de edades se encuentra?
  'Genero',                      # ¿Con qué género se identifica?
  'Nivel.Educativo',             # Indique su nivel educativo máximo alcanzado
  'Situacion.Laboral'            # ¿En qué situación laboral se encuentra?
)

colnames(datos) <- nuevos_nombres
```

## Transformación de Variables
Definimos las variables como categóricas. 

```{r transformacion}


datos$f_Motivo <- factor(datos$Motivo,
  levels = c('Conveniencia (falta de tiempo, por trabajo, estudios, etc.)', 
             'Reuniones sociales (familia, amigos, compañeros de trabajo, etc.)', 
             'Placer o disfrute personal (por gusto, por probar cosas nuevas, por cambiar de ambiente)', 
             'Circunstancias extraordinarias (viajes, eventos...)', 
             'Nunca como fuera de casa'),
  labels = c('Conveniencia', 'Social', 'Placer', 'Extraordinario', 'Nunca'))

datos$f_Lugar.Habitual <- factor(datos$Lugar.Habitual,
  levels = c('En un bar o restaurante', 
             'En una oficina o centro educativo (cantina, comedor, aula...)', 
             'En la vía pública (parques, calle, transporte, etc.)'),
  labels = c('Restaurante/Bar', 'Oficina/Centro', 'Vía Pública'))

datos$f_Formato.Preferido <- factor(datos$Formato.Preferido,
  levels = c('Tamaños de recipiente fijos con un precio establecido por tamaño', 'Pago por peso'),
  labels = c('Precio Fijo', 'Pago Peso'))

datos$f_Preferencia.Dispensacion <- factor(datos$Preferencia.Dispensacion,
  levels = c('Ingredientes expuestos tras una mampara de cristal, donde el cliente abre la protección y utiliza pinzas para servirse en su propio recipiente (similar a un autoservicio tipo buffet)', 
             'Ingredientes protegidos por una barrera de cristal fija, sin acceso directo. Se utilizan palas largas para dispensarlos desde un lateral, evitando cualquier contacto del cliente con el producto, aunque con algo menos de comodidad (similar al sistema de algunas panaderías)', 
             'Ingredientes servidos por personal de atención.'),
  labels = c('Autoservicio', 'Protección Fija', 'Personal'))

datos$f_Genero <- factor(datos$Genero,
  levels = c('Mujer', 'Hombre', 'Prefiero no decirlo', 'Otro:'),
  labels = c('Mujer', 'Hombre', 'NS/NC', 'Otro'))

datos$f_Situacion.Laboral <- factor(datos$Situacion.Laboral,
  levels = c('Estudiante', 'Trabajador/a por cuenta ajena', 'Autónomo/a', 'Desempleado/a', 'Jubilado/a', 'Prefiero no decirlo'),
  labels = c('Estudiante', 'Cuenta Ajena', 'Autónomo', 'Desempleado', 'Jubilado', 'NS/NC'))

datos$f_Experiencia.Barra <- factor(datos$Experiencia.Barra.Ensaladas, levels = c('Sí', 'No'))
datos$f_Intencion.Uso <- factor(datos$Intencion.Uso, levels = c('Sí', 'No'))

datos$f_Frecuencia <- factor(datos$Frecuencia,
  levels = c('Rara vez / Nunca', 'Ocasionalmente', '1 o 2 veces por semana', '3 o 4 veces por semana', '5 o más veces por semana'),
  labels = c('Nunca/Rara', 'Ocasional', '1-2/sem', '3-4/sem', '5+/sem'))

datos$f_Frecuencia.Comida.Preparada <- factor(datos$Frecuencia.Comida.Preparada,
  levels = c('Rara vez / Nunca', 'Ocasionalmente', '1 o 2 veces por semana', '3 o 4 veces por semana', '5 o más veces por semana'),
  labels = c('Nunca/Rara', 'Ocasional', '1-2/sem', '3-4/sem', '5+/sem'))

# Escalas Likert (1-5)
niveles_likert <- c(1:5)
etiquetas_likert <- c('1', '2', '3', '4', '5')

datos$f_Importancia.Saludable <- factor(datos$Importancia.Saludable, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Sostenibilidad    <- factor(datos$Imp.Sostenibilidad, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Origen.Local      <- factor(datos$Imp.Origen.Local, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Variedad          <- factor(datos$Imp.Variedad, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Sabor             <- factor(datos$Imp.Sabor, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Precio            <- factor(datos$Imp.Precio, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Higiene           <- factor(datos$Imp.Higiene, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Rapidez           <- factor(datos$Imp.Rapidez, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Aptitud.Social        <- factor(datos$Aptitud.Social, levels = niveles_likert, labels = etiquetas_likert)

datos$f_Disposicion.Pago <- factor(datos$Disposicion.Pago,
  levels = c('Menos de 4€', 'Entre 4 y 5,49€', 'Entre 5,50 y 7€', 'Entre 7 y 9,50€', 'Más de 9,50€'),
  labels = c('<4€', '4-5.5€', '5.5-7€', '7-9.5€', '>9.5€'))

datos$f_Edad <- factor(datos$Edad,
  levels = c('Menor de 18', '18-24', '25-44', '45-64', '65+'))

datos$f_Nivel.Educativo <- factor(datos$Nivel.Educativo,
  levels = c('ESO (antiguo BUP)', 'FP medio o Bachillerato (antiguo COU)', 'FP superior', 'Universitario/a'),
  labels = c('ESO', 'Bachiller/FPm', 'FPs', 'Univ'))

# ----- PREGUNTAS CON MÁS DE UNA RESPUESTA ---

# Lista de variables multirespuesta
multi_res <- c("Tipo.Comida", "Supermercado.Habitual", "Situaciones.Uso", 
                "Preferencia.Base", "Preferencia.Proteina", "Preferencia.Complementos")

# Aplicamos cSplit_e a cada una (separa por ", " y rellena con 0)
for (var in multi_res) {
  datos <- cSplit_e(datos, var, sep = ', ', type = 'character', fill = 0)
}


# !!!!!!!!!!!!!!!!!!!!! Si alguno da error es porque nadie lo ha marcado en la encuesta y la columna no existe, sería comentar esa línea

# --- P4: Tipo de Comida ---
datos$f_Tipo.Comida.Rapida <- factor(datos$`Tipo.Comida_Comida rápida`, 
                                     levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Tipo.Comida.Restaurante <- factor(datos$`Tipo.Comida_Comida preparada en un bar o restaurante (Excluyendo comida rápida)`, 
                                          levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Tipo.Comida.Super <- factor(datos$`Tipo.Comida_Platos preparados de supermercado`, 
                                    levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Tipo.Comida.Propia <- factor(datos$`Tipo.Comida_De elaboración propia`, 
                                     levels = c(0, 1), labels = c('No', 'Sí'))

# --- P6: Supermercados (Principales) ---

datos$f_Super.Mercadona <- factor(datos$Supermercado.Habitual_Mercadona, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Consum    <- factor(datos$Supermercado.Habitual_Consum, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Carrefour <- factor(datos$Supermercado.Habitual_Carrefour, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Lidl      <- factor(datos$Supermercado.Habitual_Lidl, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Aldi      <- factor(datos$Supermercado.Habitual_Aldi, levels = c(0, 1), labels = c('No', 'Sí'))

# --- P10: Situaciones de Uso ---
datos$f_Uso.Momento <- factor(datos$`Situaciones.Uso_Para comer en el momento`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Uso.Llevar  <- factor(datos$`Situaciones.Uso_Para llevar al trabajo/universidad`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Uso.Cena    <- factor(datos$`Situaciones.Uso_Como cena ligera`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Uso.Complem <- factor(datos$`Situaciones.Uso_Como complemento de otra comida`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))

# --- P13: Preferencia Base ---
datos$f_Base.Lechuga <- factor(datos$`Preferencia.Base_Lechuga iceberg o romana`, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
# Cuidado con esta línea, el nombre es muy largo y tiene símbolos:
datos$f_Base.Verde   <- factor(datos$`Preferencia.Base_Mezcla verde: rúcula/canónigos/espinacas...`, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Base.Pasta   <- factor(datos$Preferencia.Base_Pasta, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Base.Quinoa  <- factor(datos$Preferencia.Base_Quinoa, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Base.Legum   <- factor(datos$Preferencia.Base_Legumbres, 
                               levels = c(0, 1), labels = c('No', 'Sí'))

# --- P14: Proteínas ---
datos$f_Prot.Pollo   <- factor(datos$Preferencia.Proteina_Pollo, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Pescado <- factor(datos$Preferencia.Proteina_Pescado, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Huevo   <- factor(datos$Preferencia.Proteina_Huevo, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Queso   <- factor(datos$Preferencia.Proteina_Quesos, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Tofu    <- factor(datos$Preferencia.Proteina_Tofu, levels = c(0, 1), labels = c('No', 'Sí'))

# Verificación final
colnames(datos)

# Verificación
colnames(datos)
```
## Control de consistencia
Hemos introducido un control de consistencia en la pregunta sobre el supermercado en el que el encuestado compra comida habitualmente. Dos de las posibles respuestas son Fnac y Lefties, que no son supermercados. Por tanto, tendremos que descartar aquellos cuestionarios que tengan marcada alguna de estas respuestas, ya que es muy probable que hayan sido respondidos al azar o de forma poca seria.

```{r control consistencia}

n.filas.bruto <- dim(datos)[1]

datos <- subset(datos, !(f_Super.Fnac))
datos <- subset(datos, !(f_Super.Lefties))

n.filas <- dim(datos)[1]

``` 

En el trabajo de campo recogimos inicialmente `r n.filas.bruto` cuestionarios. Tras realizar el control de consistencia, nuestra muestra efectiva es de `r n.filas` cuestionarios válidos.