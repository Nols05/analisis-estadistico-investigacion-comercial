---
title: 'Análisis de Mercado: Barra de Ensaladas'
author: "Noel Lirón Martínez, Raquel Mus Maquieira, Carles Sahuquillo Soriano"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true
  pdf_document:
    toc: true
subtitle: 'Asignatura: Investigación Comercial'
---

```{r setup, include=FALSE}
# Configuración global
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 10)
```

# Preparación del Entorno


```{r librerias}
# Carga de librerías y configuraciones
if (!require("pacman")) install.packages("pacman")

pacman::p_load(
  readxl, splitstackshape, descr, rstatix, 
  tibble, dplyr, tidyr, ggplot2, 
  xtable, likert, ggpubr, flextable, 
  nortest, DT, RColorBrewer, graphics
)

options(digits = 3)

theme_set(theme_minimal() + 
            theme(plot.title = element_text(face = "bold", hjust = 0.5),
                  legend.position = "bottom"))
```

---

# Ingesta y Limpieza de Datos {.tabset}

En esta sección procesamos el archivo crudo `respuestasEncuesta.xlsx`, renombrando las columnas para facilitar su manipulación y convirtiendo las variables categóricas.

## Carga y Renombrado

```{r carga_datos}
# Carga de datos y renombramiento de columnas

datos <- read_excel('respuestasEncuesta.xlsx')

nuevos_nombres <- c(
  'Marca.Temporal',              # Marca temporal
  'Motivo',                      # ¿Cuál es el principal motivo por el que suele comer fuera de casa?
  'Frecuencia',                  # ¿Con qué frecuencia suele comer fuera de casa?
  'Lugar.Habitual',              # Cuando come fuera ¿dónde suele comer?
  'Tipo.Comida',                 # Cuando come fuera, ¿qué tipo de comida suele elegir?
  'Frecuencia.Comida.Preparada', # ¿Con qué frecuencia compra comida preparada en un supermercado?
  'Supermercado.Habitual',       # ¿En qué supermercados suele comprar comida?
  'Importancia.Saludable',       # ¿Qué importancia tiene para usted comer de forma saludable cuando está fuera de casa?
  'Experiencia.Barra.Ensaladas', # ¿Ha probado alguna vez una barra de ensaladas?
  'Mala.Experiencia.Descripcion',# ¿Puede describir alguna mala experiencia que haya tenido con comida preparada o autoservicio...?
  'Situaciones.Uso',             # ¿En qué situaciones utilizaría la barra de ensaladas?
  'Formato.Preferido',           # ¿Qué formato preferiría?
  'Imp.Sostenibilidad',          # Valore importancia: [Sostenibilidad de los envases]
  'Imp.Origen.Local',            # Valore importancia: [Origen local de los productos]
  'Imp.Variedad',                # Valore importancia: [Variedad de ingredientes]
  'Imp.Sabor',                   # Valore importancia: [Sabor]
  'Imp.Precio',                  # Valore importancia: [Precio]
  'Imp.Higiene',                 # Valore importancia: [Higiene]
  'Imp.Rapidez',                 # Valore importancia: [Rapidez del servicio]
  'Preferencia.Base',            # ¿Qué tipo de base prefiere para sus ensaladas? (Hasta 2 opciones)
  'Preferencia.Proteina',        # De las siguientes proteínas ¿cuáles prefiere? (Hasta 2 opciones)
  'Preferencia.Complementos',    # De los siguientes complementos ¿cuáles prefiere? (Hasta 2 opciones)
  'Disposicion.Pago',            # ¿Cuánto está dispuesto/a a pagar por una ensalada completa de tamaño mediano (500g)?
  'Aptitud.Social',              # ¿Qué tan apropiadas considera las ensaladas para comidas en contextos sociales?
  'Preferencia.Dispensacion',    # ¿Qué formato de dispensación preferiría? (Comodidad, rapidez e higiene)
  'Intencion.Uso',               # Si su supermercado habitual ofreciera nuestra barra de ensaladas, ¿la usaría?
  'Edad',                        # ¿En qué rango de edades se encuentra?
  'Genero',                      # ¿Con qué género se identifica?
  'Nivel.Educativo',             # Indique su nivel educativo máximo alcanzado
  'Situacion.Laboral'            # ¿En qué situación laboral se encuentra?
)

colnames(datos) <- nuevos_nombres
```

## Transformación de Variables
Definimos las variables como categóricas. 

```{r transformacion}


datos$f_Motivo <- factor(datos$Motivo,
  levels = c('Conveniencia (falta de tiempo, por trabajo, estudios, etc.)', 
             'Reuniones sociales (familia, amigos, compañeros de trabajo, etc.)', 
             'Placer o disfrute personal (por gusto, por probar cosas nuevas, por cambiar de ambiente)', 
             'Circunstancias extraordinarias (viajes, eventos...)', 
             'Nunca como fuera de casa'),
  labels = c('Conveniencia', 'Social', 'Placer', 'Extraordinario', 'Nunca'))

datos$f_Lugar.Habitual <- factor(datos$Lugar.Habitual,
  levels = c('En un bar o restaurante', 
             'En una oficina o centro educativo (cantina, comedor, aula...)', 
             'En la vía pública (parques, calle, transporte, etc.)'),
  labels = c('Restaurante/Bar', 'Oficina/Centro', 'Vía Pública'))

datos$f_Formato.Preferido <- factor(datos$Formato.Preferido,
  levels = c('Tamaños de recipiente fijos con un precio establecido por tamaño', 'Pago por peso'),
  labels = c('Precio Fijo', 'Pago Peso'))

datos$f_Preferencia.Dispensacion <- factor(datos$Preferencia.Dispensacion,
  levels = c('Ingredientes expuestos tras una mampara de cristal, donde el cliente abre la protección y utiliza pinzas para servirse en su propio recipiente (similar a un autoservicio tipo buffet)', 
             'Ingredientes protegidos por una barrera de cristal fija, sin acceso directo. Se utilizan palas largas para dispensarlos desde un lateral, evitando cualquier contacto del cliente con el producto, aunque con algo menos de comodidad (similar al sistema de algunas panaderías)', 
             'Ingredientes servidos por personal de atención.'),
  labels = c('Autoservicio', 'Protección Fija', 'Personal'))

datos$f_Genero <- factor(datos$Genero,
  levels = c('Mujer', 'Hombre', 'Prefiero no decirlo', 'Otro:'),
  labels = c('Mujer', 'Hombre', 'NS/NC', 'Otro'))

datos$f_Situacion.Laboral <- factor(datos$Situacion.Laboral,
  levels = c('Estudiante', 'Trabajador/a por cuenta ajena', 'Autónomo/a', 'Desempleado/a', 'Jubilado/a', 'Prefiero no decirlo'),
  labels = c('Estudiante', 'Cuenta Ajena', 'Autónomo', 'Desempleado', 'Jubilado', 'NS/NC'))

datos$f_Experiencia.Barra <- factor(datos$Experiencia.Barra.Ensaladas, levels = c('Sí', 'No'))
datos$f_Intencion.Uso <- factor(datos$Intencion.Uso, levels = c('Sí', 'No'))

datos$f_Frecuencia <- factor(datos$Frecuencia,
  levels = c('Rara vez / Nunca', 'Ocasionalmente', '1 o 2 veces por semana', '3 o 4 veces por semana', '5 o más veces por semana'),
  labels = c('Nunca/Rara', 'Ocasional', '1-2/sem', '3-4/sem', '5+/sem'))

datos$f_Frecuencia.Comida.Preparada <- factor(datos$Frecuencia.Comida.Preparada,
  levels = c('Rara vez / Nunca', 'Ocasionalmente', '1 o 2 veces por semana', '3 o 4 veces por semana', '5 o más veces por semana'),
  labels = c('Nunca/Rara', 'Ocasional', '1-2/sem', '3-4/sem', '5+/sem'))

# Escalas Likert (1-5)
niveles_likert <- c(1:5)
etiquetas_likert <- c('1', '2', '3', '4', '5')

datos$f_Importancia.Saludable <- factor(datos$Importancia.Saludable, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Sostenibilidad    <- factor(datos$Imp.Sostenibilidad, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Origen.Local      <- factor(datos$Imp.Origen.Local, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Variedad          <- factor(datos$Imp.Variedad, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Sabor             <- factor(datos$Imp.Sabor, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Precio            <- factor(datos$Imp.Precio, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Higiene           <- factor(datos$Imp.Higiene, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Imp.Rapidez           <- factor(datos$Imp.Rapidez, levels = niveles_likert, labels = etiquetas_likert)
datos$f_Aptitud.Social        <- factor(datos$Aptitud.Social, levels = niveles_likert, labels = etiquetas_likert)

datos$f_Disposicion.Pago <- factor(datos$Disposicion.Pago,
  levels = c('Menos de 4€', 'Entre 4 y 5,49€', 'Entre 5,50 y 7€', 'Entre 7 y 9,50€', 'Más de 9,50€'),
  labels = c('<4€', '4-5.5€', '5.5-7€', '7-9.5€', '>9.5€'))

datos$f_Edad <- factor(datos$Edad,
  levels = c('Menor de 18', '18-24', '25-44', '45-64', '65+'))

datos$f_Nivel.Educativo <- factor(datos$Nivel.Educativo,
  levels = c('ESO (antiguo BUP)', 'FP medio o Bachillerato (antiguo COU)', 'FP superior', 'Universitario/a'),
  labels = c('ESO', 'Bachiller/FPm', 'FPs', 'Univ'))

# ----- PREGUNTAS CON MÁS DE UNA RESPUESTA ---

# Lista de variables multirespuesta
multi_res <- c("Tipo.Comida", "Supermercado.Habitual", "Situaciones.Uso", 
                "Preferencia.Base", "Preferencia.Proteina", "Preferencia.Complementos")

# Aplicamos cSplit_e a cada una (separa por ", " y rellena con 0)
for (var in multi_res) {
  datos <- cSplit_e(datos, var, sep = ', ', type = 'character', fill = 0)
}


# !!!!!!!!!!!!!!!!!!!!! Si alguno da error es porque nadie lo ha marcado en la encuesta y la columna no existe, sería comentar esa línea

# --- P4: Tipo de Comida ---
datos$f_Tipo.Comida.Rapida <- factor(datos$`Tipo.Comida_Comida rápida`, 
                                     levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Tipo.Comida.Restaurante <- factor(datos$`Tipo.Comida_Comida preparada en un bar o restaurante (Excluyendo comida rápida)`, 
                                          levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Tipo.Comida.Super <- factor(datos$`Tipo.Comida_Platos preparados de supermercado`, 
                                    levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Tipo.Comida.Propia <- factor(datos$`Tipo.Comida_De elaboración propia`, 
                                     levels = c(0, 1), labels = c('No', 'Sí'))

# --- P6: Supermercados (Principales) ---

datos$f_Super.Mercadona <- factor(datos$Supermercado.Habitual_Mercadona, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Consum    <- factor(datos$Supermercado.Habitual_Consum, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Carrefour <- factor(datos$Supermercado.Habitual_Carrefour, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Lidl      <- factor(datos$Supermercado.Habitual_Lidl, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Aldi      <- factor(datos$Supermercado.Habitual_Aldi, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Masymas   <- factor(datos$Supermercado.Habitual_Masymas, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Alcampo   <- factor(datos$Supermercado.Habitual_Alcampo, levels = c(0, 1), labels = c('No', 'Sí'))
#datos$f_Super.Gadis     <- factor(datos$Supermercado.Habitual_Gadis, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Fnac      <- factor(datos$Supermercado.Habitual_Fnac, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.DIA       <- factor(datos$Supermercado.Habitual_DIA, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Dialprix  <- factor(datos$Supermercado.Habitual_Dialprix, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Super.Lefties   <- factor(datos$Supermercado.Habitual_Lefties, levels = c(0, 1), labels = c('No', 'Sí'))

# --- P10: Situaciones de Uso ---
datos$f_Uso.Momento <- factor(datos$`Situaciones.Uso_Para comer en el momento`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Uso.Llevar  <- factor(datos$`Situaciones.Uso_Para llevar al trabajo/universidad`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Uso.Cena    <- factor(datos$`Situaciones.Uso_Como cena ligera`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Uso.Complem <- factor(datos$`Situaciones.Uso_Como complemento de otra comida`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Uso.Nunca   <- factor(datos$`Situaciones.Uso_Nunca`, 
                              levels = c(0, 1), labels = c('No', 'Sí'))

# --- P13: Preferencia Base ---
datos$f_Base.Lechuga <- factor(datos$`Preferencia.Base_Lechuga iceberg o romana`, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
# Cuidado con esta línea, el nombre es muy largo y tiene símbolos:
datos$f_Base.Verde   <- factor(datos$`Preferencia.Base_Mezcla verde: rúcula/canónigos/espinacas...`,
                               levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Base.Pasta   <- factor(datos$Preferencia.Base_Pasta, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Base.Quinoa  <- factor(datos$Preferencia.Base_Quinoa, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Base.Cuscus  <- factor(datos$`Preferencia.Base_Cuscús`, 
                               levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Base.Legum   <- factor(datos$Preferencia.Base_Legumbres, 
                               levels = c(0, 1), labels = c('No', 'Sí'))

# --- P14: Proteínas ---
datos$f_Prot.Pollo   <- factor(datos$Preferencia.Proteina_Pollo, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Pescado <- factor(datos$Preferencia.Proteina_Pescado, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Huevo   <- factor(datos$Preferencia.Proteina_Huevo, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Queso   <- factor(datos$Preferencia.Proteina_Quesos, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Tofu    <- factor(datos$Preferencia.Proteina_Tofu, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Marisco <- factor(datos$Preferencia.Proteina_Marisco, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Prot.Carne   <- factor(datos$Preferencia.Proteina_Carne, levels = c(0, 1), labels = c('No', 'Sí'))

# --- P15: Complementos ---
datos$f_Complem.Frutas   <- factor(datos$`Preferencia.Complementos_Frutas varias`, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Complem.Secos    <- factor(datos$`Preferencia.Complementos_Frutos secos/semillas`, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Complem.Verduras <- factor(datos$`Preferencia.Complementos_Verduras cocinadas`, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Complem.Salsas   <- factor(datos$`Preferencia.Complementos_Salsas varias`, levels = c(0, 1), labels = c('No', 'Sí'))
datos$f_Complem.Especias    <- factor(datos$Preferencia.Complementos_Especias, levels = c(0, 1), labels = c('No', 'Sí'))

# Verificación final
colnames(datos)
```
## Control de consistencia
Hemos introducido un control de consistencia en la pregunta sobre el supermercado en el que el encuestado compra comida habitualmente. Dos de las posibles respuestas son `Fnac` y `Lefties`, que no son supermercados. Por tanto, tendremos que descartar aquellos cuestionarios que tengan marcada alguna de estas respuestas, ya que es muy probable que hayan sido respondidos al azar o de forma poca seria.

```{r control consistencia}

n.filas.bruto <- dim(datos)[1]

datos <- subset(datos, !(Supermercado.Habitual %in% 'Fnac'))
datos <- subset(datos, !(Supermercado.Habitual %in% 'Lefties'))

n.filas <- dim(datos)[1]

``` 

En el trabajo de campo recogimos inicialmente `r n.filas.bruto` cuestionarios. Tras realizar el control de consistencia, nuestra muestra efectiva es de `r n.filas` cuestionarios válidos.

# Estadísticos descriptivos (Análisis Univariante)
Vamos a distinguir tres tipos de variables: categóricas, numéricas y cualitativas. Cada una tiene un tratamiento descriptivo diferente.

## Variables catégoricas

### Caso de variables catégoricas carentes de orden

#### `f_Motivo`
Las categorías de `f_Motivo` son los motivos por los que los encuestados comen fuera de casa. Se trata de una variable cuyas categorías no guardan una relación de orden entre sí.

```{r P1-tarta}
# Crear el data frame de frecuencias y porcentajes usando dplyr
datos_grafico <- datos %>%
  # Contar la frecuencia de cada nivel de la variable f_Motivo
  count(f_Motivo, name = "Frecuencia") %>%
  # Calcular el porcentaje y el texto de la etiqueta
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Etiquetas = paste0(f_Motivo, "\n(", round(Porcentaje, 1), "%)") # Etiqueta para el gráfico
  ) %>%
  # Eliminar filas con 0% si existen, y categorías no deseadas
  filter(Porcentaje > 0 & f_Motivo != "Total") # Se filtra 'Total' aunque dplyr no lo añade

# Usamos el vector de Porcentaje para el tamaño de las porciones
pie(datos_grafico$Porcentaje,
    # Usamos las Etiquetas que combinan nombre y porcentaje
    labels = datos_grafico$Etiquetas,
    # Título
    main = 'Figura 1. Motivos de compra.',
    # Asignar un color diferente a cada porción
    col = RColorBrewer::brewer.pal(n = nrow(datos_grafico), name = "Set3"))

```
Se observa que `Conveniencia` es el principal motivo por el que los encuestados comen fuera de casa, representando el 38.9% de la muestra. A continuación presentamos los resultados en formato de tabla:

```{r P1-tabla}
# Preparación de datos
df_tabla_motivo <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Motivo, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Motivo = "Total",
  Frecuencia = sum(df_tabla_motivo$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_motivo, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 1. Distribución de frecuencias para Motivo de Comer Fuera.") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Motivo = "Motivo de Comer Fuera",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Lugar.Habitual`
Las categorías de `f_Lugar.Habitual` son los lugares en los que los encuestados comen fuera de casa. Se trata de una variable cuyas categorías no guardan una relación de orden entre sí.

```{r P3-tarta}
# Crear el data frame de frecuencias y porcentajes usando dplyr
datos_grafico <- datos %>%
  # Contar la frecuencia de cada nivel de la variable f_Lugar.Habitual
  count(f_Lugar.Habitual, name = "Frecuencia") %>%
  # Calcular el porcentaje y el texto de la etiqueta
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Etiquetas = paste0(f_Lugar.Habitual, "\n(", round(Porcentaje, 1), "%)") # Etiqueta para el gráfico
  ) %>%
  # Eliminar filas con 0% si existen, y categorías no deseadas
  filter(Porcentaje > 0 & f_Lugar.Habitual != "Total") # Se filtra 'Total' aunque dplyr no lo añade

# Usamos el vector de Porcentaje para el tamaño de las porciones
pie(datos_grafico$Porcentaje,
    # Usamos las Etiquetas que combinan nombre y porcentaje
    labels = datos_grafico$Etiquetas,
    # Título
    main = 'Figura 2. Lugar habitual.',
    # Asignar un color diferente a cada porción
    col = RColorBrewer::brewer.pal(n = nrow(datos_grafico), name = "Set3"))

```
Se observa que `Restaurante/Bar` es el principal lugar en el que los encuestados comen fuera de casa, representando el 71.4% de la muestra. A continuación presentamos los resultados en formato de tabla:

```{r P3-tabla}
# Preparación de datos
df_tabla_lugar <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Lugar.Habitual, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Lugar.Habitual = "Total",
  Frecuencia = sum(df_tabla_lugar$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_lugar, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 2. Distribución de frecuencias para Lugar habitual en el que se come fuera de casa.") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Lugar.Habitual = "Lugar Habitual",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Tipo.Comida`
Las categorías de `f_Tipo.Comida` hacen referencia al tipo de comida que los encuestados suelen comer cuando comen fuera de casa. Es importante destacar que esta variable proviene de una pregunta con respuesta múltiple por lo que optamos por un gráfico de barras múltiple basándonos en si ha se ha seleccionado cada respuesta o no.
```{r P4-barras, fig.height=6, fig.width=10}
# Definir las variables a analizar (P4: Tipo de Comida)
multi_vars <- c("f_Tipo.Comida.Rapida", "f_Tipo.Comida.Restaurante", "f_Tipo.Comida.Super", 
                "f_Tipo.Comida.Propia")

# Transformar a formato largo y contar frecuencias de SÍ/NO
df_barras_dobles <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Tipo_de_Comida", 
    values_to = "Respuesta"
  ) %>%
  dplyr::count(Tipo_de_Comida, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Tipo_de_Comida = gsub("f_Tipo.Comida.", "", Tipo_de_Comida, fixed = TRUE),
    Tipo_de_Comida = tools::toTitleCase(Tipo_de_Comida),
    Respuesta = factor(Respuesta, levels = c("No", "Sí")) 
  )

# Generación del Gráfico de Barras Agrupadas (Horizontal)
ggplot(df_barras_dobles, aes(x = Tipo_de_Comida, y = Frecuencia, fill = Respuesta)) +
  
  # Barras agrupadas
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) + 
  
  # Etiquetas de Frecuencia
  geom_text(
    aes(label = Frecuencia),
    position = position_dodge(width = 0.9),
    hjust = -0.2, # Mueve la etiqueta -0.2 unidades a lo largo del eje X (separa de la barra)
    size = 3.5
  ) +
  
  # Títulos y Ejes
  labs(
    title = "Figura 3. Gráfico de barras (Sí/No) por Tipo de Comida",
    x = "Tipo de Comida Consumida",
    y = "Número de Encuestados",
    fill = "Consumo"
  ) +
  
  # Colores
  scale_fill_manual(values = c("No" = "#a6cee3", "Sí" = "#1f78b4")) + 
  
  # Invertir coordenadas para hacerlo horizontal
  coord_flip() + 
  
  # Ajuste del eje para que no se corten las etiquetas (Aumentamos el espacio)
  scale_y_continuous(expand = expansion(mult = c(0, 0.20))) + 
  
  # Ajuste de Tema
  theme(legend.position = "bottom")
```
Se observa una clara dominancia del consumo de comida de restaurante (con 27 respuestas afirmativas), seguido de comida de elaboración propia (con 11 respuestas afirmativas). Estos resultados sugieren que los consumidores están acostumbrados a un formato de comida que prioriza una comida preparada y de calidad. A  continuación presentamos los resultados en formato de tabla:

```{r P4-tabla}
# Transformar a formato largo, contar frecuencias de SÍ/NO y calcular porcentajes
df_tabla_temp <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Tipo_de_Comida_Raw", 
    values_to = "Respuesta" 
  ) %>%
  dplyr::count(Tipo_de_Comida_Raw, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Porcentaje = (Frecuencia / n.filas) * 100
  ) %>%
  tidyr::pivot_wider(
    names_from = Respuesta, 
    values_from = c(Frecuencia, Porcentaje),
    values_fill = 0 
  ) %>%
  dplyr::mutate(
    Tipo_de_Comida = gsub("f_Tipo.Comida.", "", Tipo_de_Comida_Raw, fixed = TRUE),
    Tipo_de_Comida = tools::toTitleCase(Tipo_de_Comida)
  ) %>%
  dplyr::select(
    Tipo_de_Comida,
    `Frecuencia_Sí`, `Porcentaje_Sí`,
    `Frecuencia_No`, `Porcentaje_No`
  )


# Fila de Total
df_total <- data.frame(
  Tipo_de_Comida = "TOTAL MENCIONES",
  Frecuencia_Sí = sum(df_tabla_temp$Frecuencia_Sí),
  Porcentaje_Sí = NA, # No se suma, sería engañoso
  Frecuencia_No = sum(df_tabla_temp$Frecuencia_No),
  Porcentaje_No = NA # No se suma, sería engañoso
)

# Unir el data frame con la fila total
df_tabla_final <- bind_rows(df_tabla_temp, df_total)


# Generación de la tabla (flextable)
ft_si_no <- flextable::flextable(df_tabla_final) %>%
  
  # Añadir Título
  flextable::set_caption(caption = "Tabla 3. Distribución de Frecuencias (Sí/No) para Tipos de Comida") %>%
  
  # Renombrar cabeceras (se usan para la segunda fila de la cabecera)
  flextable::set_header_labels(
    Tipo_de_Comida = "Tipo de Comida",
    Frecuencia_Sí = "Frecuencia (n)",
    Porcentaje_Sí = "Porcentaje",
    Frecuencia_No = "Frecuencia (n)",
    Porcentaje_No = "Porcentaje"
  ) %>%
  
  # Agrupar las columnas 'Sí' y 'No' en una fila superior
  flextable::add_header_row(
    values = c(" ", "SÍ", "NO"),
    colwidths = c(1, 2, 2)
  ) %>%
  
  # Formato y Tema
  flextable::colformat_double(j = c(3, 5), digits = 1, suffix = "%", na_str = "") %>% 
  
  flextable::theme_booktabs() %>% 
  
  # Alineación
  # Aplicar negrita y bordes a la fila "Total" (la última fila)
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% 
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Alineación
  flextable::align(align = "center", part = "all") %>%
  flextable::align(j = 1, align = "left", part = "body") %>%
  
  # Ajustar
  flextable::autofit()

# Mostrar la tabla
ft_si_no
```

#### `f_Supermercado.Habitual`
Las categorías de `f_Supermercado.Habitual` hacen referencia al supermercado en el que los encuestados suelen comprar comida. Es importante destacar que esta variable proviene de una pregunta con respuesta múltiple por lo que optamos por un gráfico de barras múltiple basándonos en si ha se ha seleccionado cada respuesta o no. También destacamos que esta pregunta es de control y no tiene más trascendencia.
```{r P6-barras, fig.height=8, fig.width=14}
# Definir las variables a analizar (P6: Supermercado)
multi_vars <- c("f_Super.Carrefour", "f_Super.Lidl", "f_Super.Mercadona", "f_Super.Consum", "f_Super.Aldi", "f_Super.Masymas", "f_Super.Alcampo", "f_Super.DIA", "f_Super.Dialprix")
#FALTA GADIS PORQUE NO SE HA ELEGIDO

# Transformar a formato largo y contar frecuencias de SÍ/NO
df_barras_dobles <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Supermercado_Habitual", 
    values_to = "Respuesta"
  ) %>%
  dplyr::count(Supermercado_Habitual, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Supermercado_Habitual = gsub("f_Super.", "", Supermercado_Habitual, fixed = TRUE),
    Supermercado_Habitual = tools::toTitleCase(Supermercado_Habitual),
    Respuesta = factor(Respuesta, levels = c("No", "Sí")) 
  )

# Generación del Gráfico de Barras Agrupadas (Horizontal)
ggplot(df_barras_dobles, aes(x = Supermercado_Habitual, y = Frecuencia, fill = Respuesta)) +
  
  # Barras agrupadas
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) + 
  
  # Etiquetas de Frecuencia
  geom_text(
    aes(label = Frecuencia),
    position = position_dodge(width = 0.9),
    hjust = -0.2, # Mueve la etiqueta -0.2 unidades a lo largo del eje X (separa de la barra)
    size = 3.5
  ) +
  
  # Títulos y Ejes
  labs(
    title = "Figura 4. Gráfico de barras (Sí/No) por Supermercado",
    x = "Supermercado Habitual",
    y = "Número de Encuestados",
    fill = "Elegido"
  ) +
  
  # Colores
  scale_fill_manual(values = c("No" = "#a6cee3", "Sí" = "#1f78b4")) + 
  
  # Invertir coordenadas para hacerlo horizontal
  coord_flip() + 
  
  # Ajuste del eje para que no se corten las etiquetas (Aumentamos el espacio)
  scale_y_continuous(expand = expansion(mult = c(0, 0.20))) + 
  
  # Ajuste de Tema
  theme(legend.position = "bottom")
```

Se observa una clara dominancia de Mercadona (con 30 respuestas afirmativas), seguido de Consum (con 12 respuestas afirmativas). A continuación presentamos los resultados en formato de tabla:

```{r P6-tabla}
# Transformar a formato largo, contar frecuencias de SÍ/NO y calcular porcentajes
df_tabla_temp <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Supermercado_Habitual_Raw", 
    values_to = "Respuesta" 
  ) %>%
  dplyr::count(Supermercado_Habitual_Raw, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Porcentaje = (Frecuencia / n.filas) * 100
  ) %>%
  tidyr::pivot_wider(
    names_from = Respuesta, 
    values_from = c(Frecuencia, Porcentaje),
    values_fill = 0 
  ) %>%
  dplyr::mutate(
    Supermercado_Habitual = gsub("f_Super.", "", Supermercado_Habitual_Raw, fixed = TRUE),
    Supermercado_Habitual = tools::toTitleCase(Supermercado_Habitual)
  ) %>%
  dplyr::select(
    Supermercado_Habitual,
    `Frecuencia_Sí`, `Porcentaje_Sí`,
    `Frecuencia_No`, `Porcentaje_No`
  )


# Fila de Total
df_total <- data.frame(
  Supermercado_Habitual = "TOTAL MENCIONES",
  Frecuencia_Sí = sum(df_tabla_temp$Frecuencia_Sí),
  Porcentaje_Sí = NA, # No se suma, sería engañoso
  Frecuencia_No = sum(df_tabla_temp$Frecuencia_No),
  Porcentaje_No = NA # No se suma, sería engañoso
)

# Unir el data frame con la fila total
df_tabla_final <- bind_rows(df_tabla_temp, df_total)


# Generación de la tabla (flextable)
ft_si_no <- flextable::flextable(df_tabla_final) %>%
  
  # Añadir Título
  flextable::set_caption(caption = "Tabla 4. Distribución de Frecuencias (Sí/No) para Supermercados") %>%
  
  # Renombrar cabeceras (se usan para la segunda fila de la cabecera)
  flextable::set_header_labels(
    Supermercado_Habitual = "Supermercado Habitual",
    Frecuencia_Sí = "Frecuencia (n)",
    Porcentaje_Sí = "Porcentaje",
    Frecuencia_No = "Frecuencia (n)",
    Porcentaje_No = "Porcentaje"
  ) %>%
  
  # Agrupar las columnas 'Sí' y 'No' en una fila superior
  flextable::add_header_row(
    values = c(" ", "SÍ", "NO"),
    colwidths = c(1, 2, 2)
  ) %>%
  
  # Formato y Tema
  flextable::colformat_double(j = c(3, 5), digits = 1, suffix = "%", na_str = "") %>% 
  
  flextable::theme_booktabs() %>% 
  
  # Alineación
  # Aplicar negrita y bordes a la fila "Total" (la última fila)
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% 
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Alineación
  flextable::align(align = "center", part = "all") %>%
  flextable::align(j = 1, align = "left", part = "body") %>%
  
  # Ajustar
  flextable::autofit()

# Mostrar la tabla
ft_si_no
```

#### `f_Experiencia.Barra`
Las categorías de `f_Experiencia.Barra` hacen referencia a si el encuestado a probado una barra de ensaladas previamente. Se trata de una variable cuyas categorías no guardan una relación de orden entre sí. Por ese motivo no se definieron los `levels` al factorizarla.

```{r P8-tarta}
# Crear el data frame de frecuencias y porcentajes usando dplyr
datos_grafico <- datos %>%
  # Contar la frecuencia de cada nivel de la variable f_Experiencia.Barra
  count(f_Experiencia.Barra, name = "Frecuencia") %>%
  # Calcular el porcentaje y el texto de la etiqueta
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100,
    Etiquetas = paste0(f_Experiencia.Barra, "\n(", round(Porcentaje, 1), "%)") # Etiqueta para el gráfico
  ) %>%
  # Eliminar filas con 0% si existen, y categorías no deseadas
  filter(Porcentaje > 0 & f_Experiencia.Barra != "Total") # Se filtra 'Total' aunque dplyr no lo añade

# Usamos el vector de Porcentaje para el tamaño de las porciones
pie(datos_grafico$Porcentaje,
    # Usamos las Etiquetas que combinan nombre y porcentaje
    labels = datos_grafico$Etiquetas,
    # Título
    main = 'Figura 5. Experiencia con barra de ensaldas.',
    # Asignar un color diferente a cada porción
    col = RColorBrewer::brewer.pal(n = nrow(datos_grafico), name = "Set3"))

```

Se observa que la mayoría de los encuestados no habían probado una barra de ensaladas (%), frente a los que si (%). A continuación presentamos los resultados en formato de tabla:

```{r P8-tabla}
# Preparación de datos
df_tabla_experiencia <- datos %>%
  # Contar la frecuencia de cada nivel
  dplyr::count(f_Experiencia.Barra, name = "Frecuencia") %>%
  # Calcular porcentajes
  dplyr::mutate(
    Porcentaje = Frecuencia / sum(Frecuencia) * 100
  ) %>%
  # Redondear y formatear los porcentajes
  dplyr::mutate(
    Porcentaje = paste0(round(Porcentaje, 1), "%")
  )

# Calcular y añadir la fila total
df_total <- data.frame(
  f_Experiencia.Barra = "Total",
  Frecuencia = sum(df_tabla_experiencia$Frecuencia),
  Porcentaje = "100.0%"
)

# Unir el data frame de frecuencias con la fila total
df_tabla_final <- bind_rows(df_tabla_experiencia, df_total)

# Generación de la tabla (flextable)
ft <- flextable::flextable(df_tabla_final) %>%

flextable::set_caption(caption = "Tabla 5. Distribución de frecuencias para Experiencia previa con una barra de ensaladas") %>%
  
  # Renombrar las cabeceras
  flextable::set_header_labels(
    f_Experiencia.Barra = "Experiencia con una barra de ensaladas",
    Frecuencia = "Frecuencia (n)",
    Porcentaje = "Porcentaje"
  ) %>%
  
  # Aplicar negrita y bordes a la fila "Total"
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% # Negrita a la última fila (Total)
  flextable::border_remove() %>% # Quitar bordes predeterminados
  flextable::theme_booktabs() %>% # Aplicar un tema con líneas horizontales
  
  # Formato de alineación y cabecera
  flextable::align(j = 1, align = "left", part = "body") %>%
  flextable::align(j = 2:3, align = "center", part = "all") %>% # Columnas 2 y 3 (Datos) CENTRADAS
  flextable::align(align = "center", part = "header") %>%        # Encabezados CENTRADOS
  
  # Añadir una línea superior a la fila "Total" para separarla
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Ajustar el ancho de las columnas
  flextable::autofit()

# Mostrar la tabla
ft
```

#### `f_Situaciones.Uso`
Las categorías de `f_Situaciones.Uso` hacen referencia a las situaciones en que los encuestados utilizarían la barra de ensaladas. Es importante destacar que esta variable proviene de una pregunta con respuesta múltiple por lo que optamos por un gráfico de barras múltiple basándonos en si ha se ha seleccionado cada respuesta o no.
```{r P10-barras, fig.height=6, fig.width=10}
# Definir las variables a analizar (P10: Situaciones de Uso)
multi_vars <- c("f_Uso.Momento", "f_Uso.Llevar", "f_Uso.Cena", "f_Uso.Complem", "f_Uso.Nunca")

# Transformar a formato largo y contar frecuencias de SÍ/NO
df_barras_dobles <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Situaciones_Uso", 
    values_to = "Respuesta"
  ) %>%
  dplyr::count(Situaciones_Uso, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Situaciones_Uso = gsub("f_Uso.", "", Situaciones_Uso, fixed = TRUE),
    Situaciones_Uso = tools::toTitleCase(Situaciones_Uso),
    Respuesta = factor(Respuesta, levels = c("No", "Sí")) 
  )

# Generación del Gráfico de Barras Agrupadas (Horizontal)
ggplot(df_barras_dobles, aes(x = Situaciones_Uso, y = Frecuencia, fill = Respuesta)) +
  
  # Barras agrupadas
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) + 
  
  # Etiquetas de Frecuencia
  geom_text(
    aes(label = Frecuencia),
    position = position_dodge(width = 0.9),
    hjust = -0.2, # Mueve la etiqueta -0.2 unidades a lo largo del eje X (separa de la barra)
    size = 3.5
  ) +
  
  # Títulos y Ejes
  labs(
    title = "Figura 6. Gráfico de barras (Sí/No) por Situaciones de Uso",
    x = "Situación de Uso",
    y = "Número de Encuestados",
    fill = "Usaría"
  ) +
  
  # Colores
  scale_fill_manual(values = c("No" = "#a6cee3", "Sí" = "#1f78b4")) + 
  
  # Invertir coordenadas para hacerlo horizontal
  coord_flip() + 
  
  # Ajuste del eje para que no se corten las etiquetas (Aumentamos el espacio)
  scale_y_continuous(expand = expansion(mult = c(0, 0.20))) + 
  
  # Ajuste de Tema
  theme(legend.position = "bottom")
```

A

```{r P10-tabla}
# Transformar a formato largo, contar frecuencias de SÍ/NO y calcular porcentajes
df_tabla_temp <- datos %>%
  dplyr::select(all_of(multi_vars)) %>%
  tidyr::pivot_longer(
    cols = everything(), 
    names_to = "Situaciones_Uso_Raw", 
    values_to = "Respuesta" 
  ) %>%
  dplyr::count(Situaciones_Uso_Raw, Respuesta, name = "Frecuencia") %>%
  dplyr::mutate(
    Porcentaje = (Frecuencia / n.filas) * 100
  ) %>%
  tidyr::pivot_wider(
    names_from = Respuesta, 
    values_from = c(Frecuencia, Porcentaje),
    values_fill = 0 
  ) %>%
  dplyr::mutate(
    Situaciones_Uso = gsub("f_Uso.", "", Situaciones_Uso_Raw, fixed = TRUE),
    Situaciones_Uso = tools::toTitleCase(Situaciones_Uso)
  ) %>%
  dplyr::select(
    Situaciones_Uso,
    `Frecuencia_Sí`, `Porcentaje_Sí`,
    `Frecuencia_No`, `Porcentaje_No`
  )


# Fila de Total
df_total <- data.frame(
  Situaciones_Uso = "TOTAL MENCIONES",
  Frecuencia_Sí = sum(df_tabla_temp$Frecuencia_Sí),
  Porcentaje_Sí = NA, # No se suma, sería engañoso
  Frecuencia_No = sum(df_tabla_temp$Frecuencia_No),
  Porcentaje_No = NA # No se suma, sería engañoso
)

# Unir el data frame con la fila total
df_tabla_final <- bind_rows(df_tabla_temp, df_total)


# Generación de la tabla (flextable)
ft_si_no <- flextable::flextable(df_tabla_final) %>%
  
  # Añadir Título
  flextable::set_caption(caption = "Tabla 6. Distribución de Frecuencias (Sí/No) para Situaciones de Uso") %>%
  
  # Renombrar cabeceras (se usan para la segunda fila de la cabecera)
  flextable::set_header_labels(
    Situaciones_Uso = "Situación de Uso",
    Frecuencia_Sí = "Frecuencia (n)",
    Porcentaje_Sí = "Porcentaje",
    Frecuencia_No = "Frecuencia (n)",
    Porcentaje_No = "Porcentaje"
  ) %>%
  
  # Agrupar las columnas 'Sí' y 'No' en una fila superior
  flextable::add_header_row(
    values = c(" ", "SÍ", "NO"),
    colwidths = c(1, 2, 2)
  ) %>%
  
  # Formato y Tema
  flextable::colformat_double(j = c(3, 5), digits = 1, suffix = "%", na_str = "") %>% 
  
  flextable::theme_booktabs() %>% 
  
  # Alineación
  # Aplicar negrita y bordes a la fila "Total" (la última fila)
  flextable::bold(i = nrow(df_tabla_final), part = "body") %>% 
  flextable::hline(i = nrow(df_tabla_final) - 1, border = officer::fp_border(width = 1.5, color = "black")) %>%
  
  # Alineación
  flextable::align(align = "center", part = "all") %>%
  flextable::align(j = 1, align = "left", part = "body") %>%
  
  # Ajustar
  flextable::autofit()

# Mostrar la tabla
ft_si_no
```

#### `f_`